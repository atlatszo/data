<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <meta name="viewport" content="width=device-width, minimal-ui, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
        <meta name="author" content="Balazs Krich" />
        <meta name="description" content="A map for Atlatszo.hu">
        <title>Átlátszó térkép</title>

        <!-- add styles and scripts -->
        <link rel="icon" type="image/ico" href="http://atlatszo.hu/wp-content/themes/atlatszo/favicon.ico?v=1"/>
        <link rel="stylesheet" type="text/css" href="css/atlatszo.css"/>
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="js/megye.js"></script>
        <script src="js/kisterseg.js"></script>
        <script src="js/telepules.js"></script>

        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script type="text/javascript" src="js/d3-tip.js"></script>
        <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    </head>

    <body>
        <div class="hidden_preloader"></div>
        <div id="header">
            <div class="logo_wrapper">
                <a href="/atlatszo">
                    <div class="logo_text">EU-FORRÁSOK</div>
                    <div class="logo_text_small">MAGYARORSZÁGON</div>
                    <img id="header_logo" src="http://atlatszo.hu/wp-content/themes/atlatszo/assets/img/sh-logos-al.png"/>
                </a>
            </div>
            <div class="search_wrapper">
                <span class="main_search_padding_box"><input class="main_search" type="text" value="" placeholder=" Te hol költenéd el a legtöbb EU-forrást?" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off" maxlength="80"/></span>
                <div class="autocomplete_container"></div>
            </div>
            <div class="header_svg_container">
                <img class="logo active_logo" id="cash_logo"/>
                <img class="logo" id="human_logo"/>
                <img class="logo" id="bank_logo" src="img/bank.png"/>
            </div>
            <div class="language_change">
                <div id="english">EN</div>
            </div>
        </div>
        <div id="map"></div>

        <script>
            //D3.JS CHART GENERATION FUNCTIONS

            var chartHover = "off";

            var adminUnit = "megye";
            var metric = "DONATION";
            var timeSeries = "DONATION_TIME";

             /**
             * Number.prototype.format(n, x, s, c)
             *
             * @param integer n: length of decimal
             * @param integer x: length of whole part
             * @param mixed   s: sections delimiter
             * @param mixed   c: decimal delimiter
             */
            Number.prototype.format = function(n, x, s, c) {
                var re = '\\d(?=(\\d{' + (x || 3) + '})+' + (n > 0 ? '\\D' : '$') + ')',
                    num = this.toFixed(Math.max(0, ~~n));
                return (c ? num.replace('.', c) : num).replace(new RegExp(re, 'g'), '$&' + (s || ','));
            }

            var hufFormat = d3.locale({
                "decimal": ".",
                "thousands": " ",
                "grouping": [3],
                "currency": ["", "HUF"],
                "dateTime": "%a %b %e %X %Y",
                "date": "%m/%d/%Y",
                "time": "%H:%M:%S",
                "periods": ["de", "du"],
                "days": ["Vasárnap", "Hétfő", "Kedd", "Szerda", "Csütörtök", "Péntek", "Szombat"],
                "shortDays": ["V", "H", "K", "Sze", "Cs", "P", "Szo"],
                "months": ["Január", "Február", "Március", "Április", "Május", "Június", "Július", "Augusztus", "Szeptember", "Október", "November", "December"],
                "shortMonths": ["Jan", "Feb", "Már", "Ápr", "Máj", "Jún", "Júl", "Aug", "Sze", "Okt", "Nov", "Dec"]
            });

            d3.format = hufFormat.numberFormat;

            function ConvertToCSV(objArray) {
                var array = typeof objArray != 'object' ? JSON.parse(objArray) : objArray;
                var str = '';

                for (var i = 0; i < array.length; i++) {
                    var line = '';
                    for (var index in array[i]) {
                        if (line != '') line += ','
                            line += array[i][index];
                        }
                        str += line + '\r\n';
                    }
                    return str;
                }

            function render_chart(songId, inputData) {
                var margin = {top: 22, right: 25, bottom: 22, left: 65},
                    width = 320 - margin.left - margin.right,
                    height = 250 - margin.top - margin.bottom;

                //var parseDate = d3.time.format("%Y-%m-%d").parse
                //var parseDate2 = d3.time.format("%d/%m/%Y").parse
                //var formatDate = d3.time.format("%A %d %b %Y");
                //var formatDate2 = d3.time.format("%d/%m/%Y");

                var parseDate = d3.time.format("%Y").parse
                var parseDate2 = d3.time.format("%Y").parse
                var formatDate = d3.time.format("%Y");
                var formatDate2 = d3.time.format("%Y");

                var x = d3.scale.ordinal()
                    .rangeRoundBands([0, width], .1);

                var y = d3.scale.linear()
                    .rangeRound([height, 0]);

                var color = d3.scale.ordinal()
                    .range(["#FF665A", "#FFCA63", "#594324", "#176B86", "#4D8E27"]);

                var songId = d3.selectAll("#playchart").append("svg")
                    .attr("class", "playchart_" + songId)
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                songId.append("g")
                    .attr("class", "background_group")

                /* Origin of data is session_account_history2.json passed by view.py. This is read
                as json then converted to .csv and loaded into D3.js for visualisation */
                var data0 =  inputData;
                var jsonObject = JSON.stringify(data0);
                var data2 = "SZ,KTIA,N,TrDate,EU,USZ"+"\n"+ConvertToCSV(jsonObject);
                console.log(data2);

                data = d3.csv.parse(data2, function(d) {
                    return {
                        TrDate: formatDate2(parseDate(d.TrDate)),
                        plays:+d.EU,
                        starts:+d.KTIA,
                        szechenyi: d.SZ,
                        ujszechenyi: d.USZ,
                        nemzeti: d.N

                    };
                });

                //console.log(JSON.stringify(data));

                color.domain(d3.keys(data[0]).filter(function(key) { return key !== "TrDate"; }));

                data.forEach(function(d) {
                    var y0 = 0;
                    d.ages = color.domain().map(function(name) { return {name: name, y0: y0, y1: y0 += +d[name], date: d["TrDate"], plays: d["plays"]}; });
                    d.total = d.ages[d.ages.length - 1].y1;
                    d.plays = d.ages[d.ages.length - 1].plays;
                });

                x.domain(data.map(function(d) { return d.TrDate; }));
                y.domain([0, d3.max(data, function(d) { return d.total; })]);

                var line = d3.svg.line()
                    .x(function(d) { return x(d.TrDate); })
                    .y(function(d) { return y(d.total); });

                var dataMiddle = Math.round((data.length-1)/2)

                var xAxis = d3.svg.axis()
                    .scale(x)
                    .orient("bottom")
                    .tickValues([data[0].TrDate, data[dataMiddle].TrDate, data[data.length -1].TrDate]);

                // function for the x grid lines
                function make_y_axis() {
                    return d3.svg.axis()
                        .scale(y)
                        .orient("left")
                        .ticks(5)
                }

                // Draw the y Grid lines
                songId.append("g")
                    .attr("class", "grid")
                    .call(make_y_axis()
                        .tickSize(-width, 0, 0)
                        .tickFormat("")
                    )

                // Draw the y Grid lines
                songId.append("g")
                    .attr("class", "grid")
                    .call(make_y_axis()
                        .tickSize(-width, 0, 0)
                        .tickFormat("")
                    )

                //d3.format = hufFormat.numberFormat

                var y_max = y.domain().slice(-1)

                var yAxis = d3.svg.axis()
                    .scale(y)
                    .orient("left")
                    .ticks(5, "s")
                    //.tickFormat(d3.format(",.0f"));
                    .tickFormat(d3.format(','));

                songId.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height+ ")")
                    .call(xAxis);

                songId.append("g")
                    .attr("class", "y axis")
                    .call(yAxis);

                /*TRENDLINE*/

                var xLabels = data.map(function (d) { return d.TrDate; })

                // get the x and y values for least squares
                var xSeries = d3.range(1, xLabels.length + 1);
                var ySeries = data.map(function(d) { return parseFloat(d.total); });
                var ySeriesPlays = data.map(function(d) { return parseFloat(d.plays); });

                var leastSquaresCoeff = leastSquares(xSeries, ySeries);
                var leastSquaresCoeffPlays = leastSquares(xSeries, ySeriesPlays);


                // apply the reults of the least squares regression

                var x1 = xLabels[0];
                var yCorr = 0;
                var yCorrPlays = 0;
                var y1 = leastSquaresCoeff[0] + leastSquaresCoeff[1];
                if (y1 < 0) {
                    yCorr = y1 *-1;
                    y1 = 0;
                }
                var y1Plays = leastSquaresCoeffPlays[0] + leastSquaresCoeffPlays[1];
                if (y1Plays < 0) {
                    yCorrPlays = y1 *-1;
                    y1Plays = 0;
                }
                var x2 = xLabels[xLabels.length - 1];
                var y2 = leastSquaresCoeff[0] * xSeries.length + leastSquaresCoeff[1] + yCorr;
                var y2Plays = leastSquaresCoeffPlays[0] * xSeries.length + leastSquaresCoeffPlays[1] + yCorrPlays;
                var trendData = [[x1,y1,x2,y2]];
                var trendDataPlays = [[x1,y1Plays,x2,y2Plays]];

                // returns slope, intercept and r-square of the line
                function leastSquares(xSeries, ySeries) {
                    var reduceSumFunc = function(prev, cur) { return prev + cur; };

                    var xBar = xSeries.reduce(reduceSumFunc) * 1.0 / xSeries.length;
                    var yBar = ySeries.reduce(reduceSumFunc) * 1.0 / ySeries.length;

                    var ssXX = xSeries.map(function(d) { return Math.pow(d - xBar, 2); })
                        .reduce(reduceSumFunc);

                    var ssYY = ySeries.map(function(d) { return Math.pow(d - yBar, 2); })
                        .reduce(reduceSumFunc);

                    var ssXY = xSeries.map(function(d, i) { return (d - xBar) * (ySeries[i] - yBar); })
                        .reduce(reduceSumFunc);

                    var slope = ssXY / ssXX;
                    var intercept = yBar - (xBar * slope);
                    var rSquare = Math.pow(ssXY, 2) / (ssXX * ssYY);

                    return [slope, intercept, rSquare];
                }

                /*TRENDLINE*/

                var transdate = songId.selectAll(".transdate")
                    .data(data)
                    .enter().append("g")
                    .attr("class", "g balance_bar")
                    .attr("transform", function(d) { return "translate(" + x(d.TrDate) + ",0)"; });


                /*var tip = d3.tip().attr('class', 'd3-tip').offset([25, 82]).html(function(data) {
                    if (data.name == "plays") {
                        return '<span class="tooltip_header plays">Number of '+data.name+': </span><span>'+humanizeNumber(data.y1)+'</span><br><span class="tooltip_header plays">Date: </span><span>'+formatDate(parseDate2(data.date))+'</span>';
                    }
                    else {
                        return '<span class="tooltip_header starts">Number of '+data.name+': </span><span>'+humanizeNumber(data.y1)+'</span><br><span class="tooltip_header starts">Date: </span><span>'+formatDate(parseDate2(data.date))+'</span>';
                    }
                });

                songId.call(tip);*/

                transdate.selectAll("rect")
                    .data(function(d) { return d.ages; })
                    .enter().append("rect")
                    .attr("width", x.rangeBand())
                    .attr("class", function(d) { return d.name +" bars"; })
                    .attr("data-date", function(d) { return d.date; })
                    .attr("y", function(d) { return y(0); })
                    .attr("height", function(d) { return y(0) - y(0); })
                    //.attr("fill", "rgba(255,255,255,0)")
                    //.style('stroke', "rgba(255,255,255,0)")
                    //.style('stroke-width', '0')
                    //.on('mouseover', tip.show)
                    //.on('mouseout', tip.hide)
                    .transition()
                    .duration(1500)
                    .attr("y", function(d) { return (y(d.y1)-1); })
                    .attr("height", function(d) { return y(d.y0) - y(d.y1); })
                    .style("fill", function(d) { return color(d.name); })
                    .style('stroke', '#333')
                    .style('stroke-width', '0.5');

                songId.selectAll(".g")
                    .data(data)
                    .attr("data", function(d) { return d.TrDate; })
                    .attr("balance", function(d) {return d.total; });

                /*TRENDLINE */

                var trendline = songId.selectAll(".trendline")
                    .data(trendData);

                trendline.enter()
                    .append("line")
                    .attr("class", "trendline")
                    .attr("x1", function(d) { return x(d[0]); })
                    .attr("y1", function(d) { return y(d[1]); })
                    .attr("x2", function(d) { return x(d[2]); })
                    .attr("y2", function(d) { return y(d[3]); })
                    .attr("stroke", "#79DCE8")
                    .attr("stroke-width", 2)
                    .style("stroke-dasharray", ("3, 3"))
                    .style("stroke-opacity", 0.7);

                var trendlinePlays = songId.selectAll(".trendlinePlays")
                    .data(trendDataPlays);

                trendlinePlays.enter()
                    .append("line")
                    .attr("class", "trendlinePlays")
                    .attr("x1", function(d) { return x(d[0]); })
                    .attr("y1", function(d) { return y(d[1]); })
                    .attr("x2", function(d) { return x(d[2]); })
                    .attr("y2", function(d) { return y(d[3]); })
                    .attr("stroke", "#79DCE8")
                    .attr("stroke-width", 2)
                    .style("stroke-dasharray", ("3, 3"))
                    .style("stroke-opacity", 0.7);

                /*TRENDLINE */
            }

            var mapboxAccessToken = "pk.eyJ1IjoiYmFsa2V5IiwiYSI6IkVEUHU3UVEifQ.ULJj3xCWhQvw4_jLEnHpTQ";
            //var map = L.map('map').setView([47.162494, 19.503304], 8);

            var map = L.map('map', {
                center: [47.162494, 19.503304],
                zoom: 7,
            });

            var geojson;
            var geojson_kisterseg

            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=' + mapboxAccessToken, {
                id: 'mapbox.streets',
                attribution: ""
            }).addTo(map);

            function getColor_m(d, metric) {
                if (metric === "DONATION") {
                    return d >= 2675472 ? '#B10026' :
                           d >= 590828  ? '#B10026' :
                           d >= 477281  ? '#E31A1C' :
                           d >= 411403  ? '#FC4E2A' :
                           d >= 339351   ? '#FD8D3C' :
                           d >= 316725   ? '#FEB24C' :
                           d >= 200732   ? '#FED976' :
                           d >= 1   ? '#FFFFB2' :
                           '#FFFFB2';
                }
                else if (metric === "CAPITA") {

                    return d >= 1543228 ? '#0C2C84' :
                           d >= 1400640  ? '#0C2C84' :
                           d >= 1008979  ? '#225EA8' :
                           d >= 883432  ? '#1D91C0' :
                           d >= 805802   ? '#41B6C4' :
                           d >= 672658   ? '#7FCDBB' :
                           d >= 387974   ? '#C7E9B4' :
                           d >= 1   ? '#FFFFCC' :
                           '#FFFFCC';
                }
            }
            function getColor_k(d, metric) {
                if (metric === "DONATION") {
                    return d >= 2292160 ? '#B10026' :
                           d >= 393346  ? '#B10026' :
                           d >= 155903  ? '#E31A1C' :
                           d >= 45328  ? '#FC4E2A' :
                           d >= 31826  ? '#FD8D3C' :
                           d >= 17689   ? '#FEB24C' :
                           d >= 17620   ? '#FED976' :
                           d >= 1   ? '#FFFFB2' :
                           '#FFFFB2';
                }
                else if (metric === "CAPITA") {
                    return d >= 6713015 ? '#0C2C84' :
                           d >= 3991456  ? '#0C2C84' :
                           d >= 1214538  ? '#225EA8' :
                           d >= 1022784  ? '#1D91C0' :
                           d >= 730618  ? '#41B6C4' :
                           d >= 561674   ? '#7FCDBB' :
                           d >= 555546   ? '#C7E9B4' :
                           d >= 1   ? '#FFFFCC' :
                           '#FFFFCC';
                }
            }

            function getColor_t(d, metric) {
                if (metric === "DONATION") {
                    return d >= 2675472 ? '#B10026' :
                           d >= 271551  ? '#B10026' :
                           d >= 3316  ? '#E31A1C' :
                           d >= 1828  ? '#FC4E2A' :
                           d >= 592   ? '#FD8D3C' :
                           d >= 133   ? '#FEB24C' :
                           d >= 130   ? '#FED976' :
                           d >= 1   ? '#FFFFB2' :
                           d === 0   ? '#D4D4D4' :
                           '#FFFFB2';
                }
                else if (metric === "CAPITA") {
                    return d >= 44534232 ? '#0C2C84' :
                           d >= 10738345  ? '#0C2C84' :
                           d >= 1635418  ? '#225EA8' :
                           d >= 864218  ? '#1D91C0' :
                           d >= 429965   ? '#41B6C4' :
                           d >= 148955   ? '#7FCDBB' :
                           d >= 147594   ? '#C7E9B4' :
                           d >= 1   ? '#FFFFCC' :
                           d === 0   ? '#D4D4D4' :
                           '#FFFFCC';
                }
            }

            function style(feature) {
                if (adminUnit === "megye" ) {
                    return {
                        fillColor: getColor_m(feature['properties'][metric], metric),
                        weight: 1,
                        opacity: 0.8,
                        color: '#333333',
                        dashArray: '',
                        fillOpacity: 0.6
                    };
                }
                else if (adminUnit === "kisterseg") {
                    return {
                        fillColor: getColor_k(feature['properties'][metric], metric),
                        weight: 1,
                        opacity: 0.8,
                        color: '#333333',
                        dashArray: '',
                        fillOpacity: 0.6
                    };
                }
                else if (adminUnit === "telepules") {
                    return {
                        fillColor: getColor_t(feature['properties'][metric], metric),
                        weight: 1,
                        opacity: 0.8,
                        color: '#333333',
                        dashArray: '',
                        fillOpacity: 0.6
                    };
                }
            }

            function highlightFeature(e) {
                var layer = e.target;

                layer.setStyle({
                    weight: 2,
                    color: '#000000',
                    dashArray: '',
                    fillOpacity: 0.2
                });

                if (!L.Browser.ie && !L.Browser.opera) {
                    layer.bringToFront();
                }
                info.update(layer.feature.properties);
            }

            function resetHighlight(e) {
                geojson.resetStyle(e.target);
                info.update();
            }

            function zoomToFeature(e) {
                map.fitBounds(e.target.getBounds());
            }

            var polylist = []
            var poly1 = [];

            function onEachFeature(feature, layer) {
                poly1 = layer.feature.geometry.coordinates;
                polylist.push(poly1);
                //console.log(JSON.stringify(poly1));

                layer.on({
                    mouseover: highlightFeature,
                    mouseout: resetHighlight,
                    click: zoomToFeature
                });
            }

            /*function onEachFeature(feature, layer) {
                layer.on({
                    mouseover: highlightFeature,
                    mouseout: resetHighlight,
                    click: zoomToFeature
                });
            }*/

            var info = L.control();

            var chart = L.control();

            info.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
                this.update();
                return this._div;
            };

            chart.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'chart'); // create a div with a class "info"
                return this._div;
            };

            // method that we will use to update the control based on feature properties passed
            info.update = function (props) {
            if (metric === "DONATION") {
                this._div.innerHTML = '<h4>Összes EU támogatás (millió Ft)</h4>' +  (props ?
                    '<b>' + props.TEL_NEV + '</b><br />' + props[metric].format(0, 3, ' ') + ' millió Ft'
                    : 'Mozgasd az egeret egy település fölé!');
            }
            else if (metric === "CAPITA") {
                this._div.innerHTML = '<h4>Egy főre jutó EU támogatás (fő / Ft)</h4>' +  (props ?
                    '<b>' + props.TEL_NEV + '</b><br />' + props[metric].format(0, 3, ' ') + ' Ft'
                    : 'Mozgasd az egeret egy település fölé!');
            }
            $('.playchart_1').remove();
            if (props) {
                $('#playchart').show();
            }
            else {
                $('#playchart').hide();
            }

            if (typeof props != "undefined") {
                //console.log(JSON.stringify(props.DONATION_TIME));
                if (typeof props[timeSeries] != "undefined") {
                    render_chart("1", props[timeSeries]);
                    $('#playchart').show();
                }
                else {
                    $('#playchart').hide();
                }
            }

            };

            info.addTo(map);
            chart.addTo(map);


            geojson = L.geoJson(megye, {
                style: style,
                onEachFeature: onEachFeature
            }).addTo(map);

            /*geojson.on('dblclick', function(event){
                map.zoomIn();
            });*/

            var legend = L.control({position: 'bottomright'});

            legend.onAdd = function (map) {

                if (map.getZoom() <= 9) {
                    if (metric === "DONATION") {
                        var div = L.DomUtil.create('div', 'info legend'),
                            grades = [0, 200731, 316724, 339350, 411402, 477280, 590827],
                            labels = [];

                        // loop through our density intervals and generate a label with a colored square for each interval
                        for (var i = 0; i < grades.length; i++) {
                        div.innerHTML +=
                            '<i style="background:' + getColor_m(grades[i] + 1, metric) + '"></i> ' +
                            (grades[i]+1).format(0, 3, ' ') + (grades[i + 1] ? ' &ndash; ' + grades[i + 1].format(0, 3, ' ') + ' millió Ft<br>' :'+ millió Ft');
                        }

                        return div;
                    }
                    else if (metric === "CAPITA") {
                        var div = L.DomUtil.create('div', 'info legend'),
                            grades = [0, 387974, 672658, 805802, 883432, 1008979, 1400640],
                            labels = [];

                        // loop through our density intervals and generate a label with a colored square for each interval
                        for (var i = 0; i < grades.length; i++) {
                        div.innerHTML +=
                            '<i style="background:' + getColor_m(grades[i] + 1, metric) + '"></i> ' +
                            (grades[i]+1).format(0, 3, ' ') + (grades[i + 1] ? ' &ndash; ' + grades[i + 1].format(0, 3, ' ') + ' Ft<br>' :'+ Ft');
                        }

                        return div;
                    }

                }
                else if (map.getZoom() <= 11) {
                    if (metric === "DONATION") {
                        var div = L.DomUtil.create('div', 'info legend'),
                            grades = [0, 17620, 17689, 31826, 45328, 155903, 393346],
                            labels = [];

                        // loop through our density intervals and generate a label with a colored square for each interval
                        for (var i = 0; i < grades.length; i++) {
                        div.innerHTML +=
                            '<i style="background:' + getColor_k(grades[i] + 1, metric) + '"></i> ' +
                            (grades[i]+1).format(0, 3, ' ') + (grades[i + 1] ? ' &ndash; ' + grades[i + 1].format(0, 3, ' ') + ' millió Ft<br>' :'+ millió Ft');
                        }

                        return div;
                    }
                    else if (metric === "CAPITA") {
                        var div = L.DomUtil.create('div', 'info legend'),
                            grades = [0, 555546, 561674, 730618, 1022784, 1214538, 3991456],
                            labels = [];

                        // loop through our density intervals and generate a label with a colored square for each interval
                        for (var i = 0; i < grades.length; i++) {
                        div.innerHTML +=
                            '<i style="background:' + getColor_k(grades[i] + 1, metric) + '"></i> ' +
                            (grades[i]+1).format(0, 3, ' ') + (grades[i + 1] ? ' &ndash; ' + grades[i + 1].format(0, 3, ' ') + ' Ft<br>' :'+ Ft');
                        }

                        return div;
                    }

                }
                else {
                    if (metric === "DONATION") {
                        var div = L.DomUtil.create('div', 'info legend'),
                            grades = [0, 130, 133, 592, 1828, 3316, 271551],
                            labels = [];

                        // loop through our density intervals and generate a label with a colored square for each interval
                        for (var i = 0; i < grades.length; i++) {
                        div.innerHTML +=
                            '<i style="background:' + getColor_t(grades[i] + 1, metric) + '"></i> ' +
                            (grades[i]+1).format(0, 3, ' ') + (grades[i + 1] ? ' &ndash; ' + grades[i + 1].format(0, 3, ' ') + ' millió Ft<br>' :'+ millió Ft');
                        }

                        return div;
                    }
                    else if (metric === "CAPITA") {
                        var div = L.DomUtil.create('div', 'info legend'),
                            grades = [0, 147594, 148955, 429965, 864218, 1635418, 10738345],
                            labels = [];

                        // loop through our density intervals and generate a label with a colored square for each interval
                        for (var i = 0; i < grades.length; i++) {
                        div.innerHTML +=
                            '<i style="background:' + getColor_t(grades[i] + 1, metric) + '"></i> ' +
                            (grades[i]+1).format(0, 3, ' ') + (grades[i + 1] ? ' &ndash; ' + grades[i + 1].format(0, 3, ' ') + ' Ft<br>' :'+ Ft');
                        }

                        return div;
                    }

                }
            };

            legend.addTo(map);

            //var testPoly = [[18.93937298717012,47.57551983739141],[18.939385328421086,47.575529743090456],[18.94322155843761,47.578608549187955],[18.948660360349606,47.57754301048777],[18.954801144578376,47.57777300773899],[18.96332430159804,47.57618754675917],[18.968043301226718,47.57602901817288],[18.977763786134986,47.57313909960147],[18.976804545804338,47.57480251145739],[18.98392142577062,47.58103095266432],[18.983627239478412,47.5824429374989],[18.98467644469998,47.583280015530306],[18.977654576193352,47.585227759095645],[18.983526822615833,47.5884422594341],[18.993888470270115,47.58401328003948],[18.9970375263913,47.585741677038286],[18.999818087402982,47.58359317440063],[19.001679424454068,47.5834140486644],[19.01369514052075,47.58667430385673],[19.020637326813542,47.58771630423521],[19.02125935985047,47.58780963500068],[19.02589920537307,47.588224376477235]];
            //L.polygon(testPoly, {fill:'url(img/apples_in_stereo.png)'}).addTo(map);

            map.on('zoomend', function() {
                // here's where you decided what zoom levels the layer should and should
                // not be available for: use javascript comparisons like < and > if
                // you want something other than just one zoom level, like
                // (map.getZoom > 10)
                if (map.getZoom() <= 9) {
                    map.removeLayer(geojson);
                    adminUnit = "megye";
                    geojson = L.geoJson(megye, {
                        style: style,
                        onEachFeature: onEachFeature
                    }).addTo(map);
                    map.removeControl(legend)
                    legend.addTo(map);
                }
                else if (map.getZoom() <= 11) {
                    map.removeLayer(geojson);
                    adminUnit = "kisterseg";
                    geojson = L.geoJson(kisterseg, {
                        style: style,
                        onEachFeature: onEachFeature
                    }).addTo(map);
                    map.removeControl(legend)
                    legend.addTo(map);
                    // setFilter is available on L.mapbox.featureLayers only. Here
                    // we're hiding and showing the default marker layer that's attached
                    // to the map - change the reference if you want to hide or show a
                    // different featureLayer.
                    // If you want to hide or show a different kind of layer, you can use
                    // similar methods like .setOpacity(0) and .setOpacity(1)
                    // to hide or show it.
                    //map.featureLayer.setFilter(function() { return true; });
                }
                else {
                    map.removeLayer(geojson);
                    adminUnit = "telepules";
                    geojson = L.geoJson(telepules, {
                        style: style,
                        onEachFeature: onEachFeature
                    }).addTo(map);
                    map.removeControl(legend)
                    legend.addTo(map);
                    //map.featureLayer.setFilter(function() { return false; });
                }
            });


            $(document).ready(function(){
               //$('.leaflet-top.leaflet-right').append('<div id="playchart"> \
               $('.chart').append('<div id="playchart"> \
                                                            <div class="legend_header">Támogatás összesen:</div> \
                                                            <div class="legend_subheader"></div> \
                                                            <div class="chart_legend"> \
                                                                <div class="legend_left legend_chart EU"> \
                                                                    <div class="legend_icon"></div> \
                                                                    <div class="legend_text">EU 2007-2013 tám. program</div> \
                                                                </div> \
                                                                <div class="legend_right legend_chart KTIA"> \
                                                                    <div class="legend_icon"></div> \
                                                                    <div class="legend_text">Kutatási, techn. és innov. alap</div> \
                                                                </div> \
                                                                <div class="legend_left legend_chart USZ"> \
                                                                    <div class="legend_icon"></div> \
                                                                    <div class="legend_text">Új Széchenyi<br>Terv</div> \
                                                                </div> \
                                                                <div class="legend_right legend_chart SZ"> \
                                                                    <div class="legend_icon"></div> \
                                                                    <div class="legend_text">Széchenyi<br>2020</div> \
                                                                </div> \
                                                                <div class="legend_left legend_chart N"> \
                                                                    <div class="legend_icon"></div> \
                                                                    <div class="legend_text">Nemzeti Fej-<br>lesztési Terv</div> \
                                                                </div> \
                                                            </div> \
                                                        </div>');


                $('.chart').on('mouseenter', function(){
                   chartHover === "on";
                   //alert(chartHover);
                });
                $('.chart').on('mouseleave', function(){
                   chartHover === "off";
                });

                /*$(".main_search").autocomplete({
                    minlength: 8,
                    autofocus: "true",
                    //appendTo: ".search_wrapper",
                    appendTo: ".autocomplete_container",
                    source: "http://www.balkeyplayer.com/search?time="+$.now(),
                    focus: function( event, ui ) {
                        //$( ".main_search" ).val( ui.item.song_title + " (" + ui.item.artist + ")");

                        return false;
                    },
                    select: function( event, ui ) {
                        $( ".main_search" ).val( ui.item.song_title + " (" + ui.item.artist + ")");
                        window.location.href = ui.item.path + "?song=" + encodeURIComponent(ui.item.song_title);

                        return false;
                    }
                });*/

                $('#human_logo').on('click', function() {
                    if(metric != "CAPITA") {
                        metric = "CAPITA";
                        timeSeries = "CAPITA_TIME";
                        map.removeLayer(geojson);
                        $('.logo').each(function(){
                           $(this).removeClass('active_logo');
                        });
                        $("#human_logo").addClass('active_logo');
                        $('.info h4').text('Egy főre jutó EU támogatás (fő / Ft)');
                        if (adminUnit === "megye") {
                            geojson = L.geoJson(megye, {
                                style: style,
                                onEachFeature: onEachFeature
                            }).addTo(map);
                        }
                        else if (adminUnit === "kisterseg") {
                            geojson = L.geoJson(kisterseg, {
                                style: style,
                                onEachFeature: onEachFeature
                            }).addTo(map);
                        }
                        else if (adminUnit === "telepules") {
                            geojson = L.geoJson(telepules, {
                                style: style,
                                onEachFeature: onEachFeature
                            }).addTo(map);
                        }
                        map.removeControl(legend)
                        legend.addTo(map);
                   }
                });

                $('#cash_logo').on('click', function() {
                    if(metric != "DONATION") {
                        metric = "DONATION";
                        timeSeries = "DONATION_TIME";
                        map.removeLayer(geojson);
                        $('.logo').each(function(){
                           $(this).removeClass('active_logo');
                        });
                        $("#cash_logo").addClass('active_logo');
                        $('.info h4').text('Összes EU támogatás (millió Ft)');
                        if (adminUnit === "megye") {
                            geojson = L.geoJson(megye, {
                                style: style,
                                onEachFeature: onEachFeature
                            }).addTo(map);
                        }
                        else if (adminUnit === "kisterseg") {
                            geojson = L.geoJson(kisterseg, {
                                style: style,
                                onEachFeature: onEachFeature
                            }).addTo(map);
                        }
                        else if (adminUnit === "telepules") {
                            geojson = L.geoJson(telepules, {
                                style: style,
                                onEachFeature: onEachFeature
                            }).addTo(map);
                        }
                        map.removeControl(legend)
                        legend.addTo(map);
                   }
                });

                function imageLoader(image, elem) {
                    var c = new Image();
                    c.onload = function(){
                        elem.css("background-image", "url("+ image+")");
                        elem.css("background-size", "100%, 100%");
                    }

                    c.src = image;
                }
                imageLoader("/img/cash_active3.png", $(".hidden_reloader"));
                imageLoader("/img/human_active.png", $(".hidden_reloader"));

                /*for (var i = 0; i < polylist.length; i++) {
                    L.polygon(polylist[i], {fill:'url(img/cash.png)'}).addTo(map);
                }*/
            });

        </script>
    </body>
</html>