<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <meta name="viewport" content="width=device-width, minimal-ui, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
        <meta name="author" content="Balazs Krich" />
        <meta name="description" content="A map for Atlatszo.hu">
        <title>Átlátszó térkép</title>

        <!-- add styles and scripts -->
        <link rel="icon" type="image/ico" href="http://atlatszo.hu/wp-content/themes/atlatszo/favicon.ico?v=1"/>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.2/css/select2.min.css" rel="stylesheet" />
        <link rel="stylesheet" type="text/css" href="css/atlatszo.css"/>
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.6/leaflet.css" />

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

        <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.2/js/select2.min.js"></script>-->

        <script type="text/javascript" src="js/autocomplete.js"></script>
        <script type="text/javascript" src="js/jquery-ui.min.js"></script>
        <script type="text/javascript" src="js/leaflet.js"></script>

        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script type="text/javascript" src="js/d3-tip.js"></script>
        <!--<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>-->
    </head>

    <body>
        <div class="sk-cube-grid">
            <div class="sk-cube sk-cube1"></div>
            <div class="sk-cube sk-cube2"></div>
            <div class="sk-cube sk-cube3"></div>
            <div class="sk-cube sk-cube4"></div>
            <div class="sk-cube sk-cube5"></div>
            <div class="sk-cube sk-cube6"></div>
            <div class="sk-cube sk-cube7"></div>
            <div class="sk-cube sk-cube8"></div>
            <div class="sk-cube sk-cube9"></div>
        </div>
        <div class="hidden_preloader"></div>
        <a href="/atlatszo">
            <div class="logo_wrapper">
                <div class="logo_text">EU-FORRÁSOK</div>
                <div class="logo_text_small">MAGYARORSZÁGON</div>
                <img id="header_logo" src="http://atlatszo.hu/wp-content/themes/atlatszo/assets/img/sh-logos-al.png"/>
            </div>
        </a>
        <div id="header">
            <div class="divider"></div>
            <div class="search_wrapper">
                <span class="main_search_padding_box"><input class="main_search" type="text" value="" placeholder=" Te hol költenéd el a legtöbb EU-forrást?" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off" maxlength="80"/></span>
                <div class="autocomplete_container"></div>
            </div>
            <div class="header_svg_container">
                <img class="logo active_logo" id="cash_logo"/>
                <img class="logo" id="human_logo"/>
                <img class="logo" id="bank_logo" src="img/bank.png"/>
            </div>
            <div class="party_selector_wrapper">
                <select id="party_selector">
                    <option value="DEVIATION_2007">2007-2009</option>
                    <option value="DEVIATION_2010">2010-2013</option>
                    <option value="DEVIATION_2014">2014-2015</option>
                </select>
            </div>
            <div class="language_change">
                <div id="english">EN</div>
            </div>
        </div>
        <div id="map"></div>

        <!--<script type="text/javascript" src="/js/megye.js"></script>
        <script type="text/javascript" src="/js/kisterseg.js"></script>-->
        <script type="text/javascript" src="js/telepules.js"></script>

        <script>
            //D3.JS CHART GENERATION FUNCTIONS

            var adminUnit = "megye";
            var metric = "DONATION";
            var timeSeries = "DONATION_TIME";
            var geojson;
            var stripes;
            var indexHamlet;

            var loader = '<div class="spinner"></div>';

             /**
             * Number.prototype.format(n, x, s, c)
             *
             * @param integer n: length of decimal
             * @param integer x: length of whole part
             * @param mixed   s: sections delimiter
             * @param mixed   c: decimal delimiter
             */
            Number.prototype.format = function(n, x, s, c) {
                var re = '\\d(?=(\\d{' + (x || 3) + '})+' + (n > 0 ? '\\D' : '$') + ')',
                    num = this.toFixed(Math.max(0, ~~n));
                return (c ? num.replace('.', c) : num).replace(new RegExp(re, 'g'), '$&' + (s || ','));
            }

            var hufFormat = d3.locale({
                "decimal": ".",
                "thousands": " ",
                "grouping": [3],
                "currency": ["", "HUF"],
                "dateTime": "%a %b %e %X %Y",
                "date": "%m/%d/%Y",
                "time": "%H:%M:%S",
                "periods": ["de", "du"],
                "days": ["Vasárnap", "Hétfő", "Kedd", "Szerda", "Csütörtök", "Péntek", "Szombat"],
                "shortDays": ["V", "H", "K", "Sze", "Cs", "P", "Szo"],
                "months": ["Január", "Február", "Március", "Április", "Május", "Június", "Július", "Augusztus", "Szeptember", "Október", "November", "December"],
                "shortMonths": ["Jan", "Feb", "Már", "Ápr", "Máj", "Jún", "Júl", "Aug", "Sze", "Okt", "Nov", "Dec"]
            });

            d3.format = hufFormat.numberFormat;

            function ConvertToCSV(objArray) {
                var array = typeof objArray != 'object' ? JSON.parse(objArray) : objArray;
                var str = '';

                for (var i = 0; i < array.length; i++) {
                    var line = '';
                    for (var index in array[i]) {
                        if (line != '') line += ','
                            line += array[i][index];
                        }
                        str += line + '\r\n';
                    }
                    return str;
                }

            function render_chart(songId, inputData) {
                var margin = {top: 22, right: 25, bottom: 22, left: 65},
                    width = 320 - margin.left - margin.right,
                    height = 250 - margin.top - margin.bottom;

                //var parseDate = d3.time.format("%Y-%m-%d").parse
                //var parseDate2 = d3.time.format("%d/%m/%Y").parse
                //var formatDate = d3.time.format("%A %d %b %Y");
                //var formatDate2 = d3.time.format("%d/%m/%Y");

                var parseDate = d3.time.format("%Y").parse
                var parseDate2 = d3.time.format("%Y").parse
                var formatDate = d3.time.format("%Y");
                var formatDate2 = d3.time.format("%Y");

                var x = d3.scale.ordinal()
                    .rangeRoundBands([0, width], .1);

                var y = d3.scale.linear()
                    .rangeRound([height, 0]);

                var color = d3.scale.ordinal()
                    .range(["#FF665A", "#FFCA63", "#594324", "#176B86", "#4D8E27"]);

                var songId = d3.selectAll("#playchart").append("svg")
                    .attr("class", "playchart_" + songId)
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                songId.append("g")
                    .attr("class", "background_group")

                /* Origin of data is session_account_history2.json passed by view.py. This is read
                as json then converted to .csv and loaded into D3.js for visualisation */
                var data0 =  inputData;
                var jsonObject = JSON.stringify(data0);
                var data2 = "SZ,KTIA,N,TrDate,EU,USZ"+"\n"+ConvertToCSV(jsonObject);
                //console.log(data2);

                data = d3.csv.parse(data2, function(d) {
                    return {
                        TrDate: formatDate2(parseDate(d.TrDate)),
                        EU:+d.EU,
                        KTIA:+d.KTIA,
                        szechenyi: d.SZ,
                        ujszechenyi: d.USZ,
                        nemzeti: d.N

                    };
                });

                color.domain(d3.keys(data[0]).filter(function(key) { return key !== "TrDate"; }));

                data.forEach(function(d) {
                    var y0 = 0;
                    d.ages = color.domain().map(function(name) { return {name: name, y0: y0, y1: y0 += +d[name], date: d["TrDate"], EU: d["EU"]}; });
                    d.total = d.ages[d.ages.length - 1].y1;
                    d.EU = d.ages[d.ages.length - 1].EU;
                });

                x.domain(data.map(function(d) { return d.TrDate; }));
                y.domain([0, d3.max(data, function(d) { return d.total; })]);

                var line = d3.svg.line()
                    .x(function(d) { return x(d.TrDate); })
                    .y(function(d) { return y(d.total); });

                var dataMiddle = Math.round((data.length-1)/2)

                var xAxis = d3.svg.axis()
                    .scale(x)
                    .orient("bottom")
                    .tickValues([data[0].TrDate, data[dataMiddle].TrDate, data[data.length -1].TrDate]);

                // function for the x grid lines
                function make_y_axis() {
                    return d3.svg.axis()
                        .scale(y)
                        .orient("left")
                        .ticks(5)
                }

                // Draw the y Grid lines
                songId.append("g")
                    .attr("class", "grid")
                    .call(make_y_axis()
                        .tickSize(-width, 0, 0)
                        .tickFormat("")
                    )

                // Draw the y Grid lines
                songId.append("g")
                    .attr("class", "grid")
                    .call(make_y_axis()
                        .tickSize(-width, 0, 0)
                        .tickFormat("")
                    )

                var y_max = y.domain().slice(-1)

                var yAxis = d3.svg.axis()
                    .scale(y)
                    .orient("left")
                    .ticks(5, "s")
                    .tickFormat(d3.format(','));

                songId.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height+ ")")
                    .call(xAxis);

                songId.append("g")
                    .attr("class", "y axis")
                    .call(yAxis);

                /*TRENDLINE*/

                var xLabels = data.map(function (d) { return d.TrDate; })

                // get the x and y values for least squares
                var xSeries = d3.range(1, xLabels.length + 1);
                var ySeries = data.map(function(d) { return parseFloat(d.total); });
                var ySeriesPlays = data.map(function(d) { return parseFloat(d.EU); });

                var leastSquaresCoeff = leastSquares(xSeries, ySeries);
                var leastSquaresCoeffPlays = leastSquares(xSeries, ySeriesPlays);


                // apply the reults of the least squares regression

                var x1 = xLabels[0];
                var yCorr = 0;
                var yCorrPlays = 0;
                var y1 = leastSquaresCoeff[0] + leastSquaresCoeff[1];
                if (y1 < 0) {
                    yCorr = y1 *-1;
                    y1 = 0;
                }
                var y1Plays = leastSquaresCoeffPlays[0] + leastSquaresCoeffPlays[1];
                if (y1Plays < 0) {
                    yCorrPlays = y1 *-1;
                    y1Plays = 0;
                }
                var x2 = xLabels[xLabels.length - 1];
                var y2 = leastSquaresCoeff[0] * xSeries.length + leastSquaresCoeff[1] + yCorr;
                if (y2 < 0) {
                    y2 = 0;
                }
                var y2Plays = leastSquaresCoeffPlays[0] * xSeries.length + leastSquaresCoeffPlays[1] + yCorrPlays;
                if (y2Plays < 0) {
                    y2Plays = 0;
                }
                var trendData = [[x1,y1,x2,y2]];
                var trendDataPlays = [[x1,y1Plays,x2,y2Plays]];

                // returns slope, intercept and r-square of the line
                function leastSquares(xSeries, ySeries) {
                    var reduceSumFunc = function(prev, cur) { return prev + cur; };

                    var xBar = xSeries.reduce(reduceSumFunc) * 1.0 / xSeries.length;
                    var yBar = ySeries.reduce(reduceSumFunc) * 1.0 / ySeries.length;

                    var ssXX = xSeries.map(function(d) { return Math.pow(d - xBar, 2); })
                        .reduce(reduceSumFunc);

                    var ssYY = ySeries.map(function(d) { return Math.pow(d - yBar, 2); })
                        .reduce(reduceSumFunc);

                    var ssXY = xSeries.map(function(d, i) { return (d - xBar) * (ySeries[i] - yBar); })
                        .reduce(reduceSumFunc);

                    var slope = ssXY / ssXX;
                    var intercept = yBar - (xBar * slope);
                    var rSquare = Math.pow(ssXY, 2) / (ssXX * ssYY);

                    return [slope, intercept, rSquare];
                }

                /*TRENDLINE*/

                var transdate = songId.selectAll(".transdate")
                    .data(data)
                    .enter().append("g")
                    .attr("class", "g balance_bar")
                    .attr("transform", function(d) { return "translate(" + x(d.TrDate) + ",0)"; });


                /*var tip = d3.tip().attr('class', 'd3-tip').offset([25, 82]).html(function(data) {
                    if (data.name == "plays") {
                        return '<span class="tooltip_header plays">Number of '+data.name+': </span><span>'+data.y1+'</span><br><span class="tooltip_header plays">Date: </span><span>'+formatDate(parseDate2(data.date))+'</span>';
                    }
                    else {
                        return '<span class="tooltip_header starts">Number of '+data.name+': </span><span>'+data.y1+'</span><br><span class="tooltip_header starts">Date: </span><span>'+formatDate(parseDate2(data.date))+'</span>';
                    }
                });

                songId.call(tip);*/

                transdate.selectAll("rect")
                    .data(function(d) { return d.ages; })
                    .enter().append("rect")
                    .attr("width", x.rangeBand())
                    .attr("class", function(d) { return d.name +" bars"; })
                    .attr("data-date", function(d) { return d.date; })
                    .attr("y", function(d) { return y(0); })
                    .attr("height", function(d) { return y(0) - y(0); })
                    //.attr("fill", "rgba(255,255,255,0)")
                    //.style('stroke', "rgba(255,255,255,0)")
                    //.style('stroke-width', '0')
                    //.on('mouseover', tip.show)
                    //.on('mouseout', tip.hide)
                    .transition()
                    .duration(0)
                    .attr("y", function(d) { return (y(d.y1)-1); })
                    .attr("data-selected", function(d) { return (y(d.y1)-1); })
                    .attr("data-balance", function(d) {return (y(d.y1)); })
                    .attr("height", function(d) { return y(d.y0) - y(d.y1); })
                    .style("fill", function(d) { return color(d.name); })
                    .style('stroke', '#333')
                    .style('opacity', '0.7')
                    .style('stroke-width', '0.5');

                songId.selectAll(".g")
                    .data(data)
                    .attr("data", function(d) { return d.TrDate; })
                    .attr("balance", function(d) {return d.total; });

                /*TRENDLINE */

                var trendline = songId.selectAll(".trendline")
                    .data(trendData);

                trendline.enter()
                    .append("line")
                    .attr("class", "trendline")
                    .attr("x1", function(d) { return x(d[0]); })
                    .attr("y1", function(d) { return y(d[1]); })
                    .attr("x2", function(d) { return x(d[2]); })
                    .attr("y2", function(d) { return y(d[3]); })
                    .attr("stroke", "#79DCE8")
                    .attr("stroke-width", 2)
                    .style("stroke-dasharray", ("3, 3"))
                    .style("stroke-opacity", 0.7);

                var trendlinePlays = songId.selectAll(".trendlinePlays")
                    .data(trendDataPlays);

                trendlinePlays.enter()
                    .append("line")
                    .attr("class", "trendlinePlays")
                    .attr("x1", function(d) { return x(d[0]); })
                    .attr("y1", function(d) { return y(d[1]); })
                    .attr("x2", function(d) { return x(d[2]); })
                    .attr("y2", function(d) { return y(d[3]); })
                    .attr("stroke", "#79DCE8")
                    .attr("stroke-width", 2)
                    .style("stroke-dasharray", ("3, 3"))
                    .style("stroke-opacity", 0.7);

                /*TRENDLINE */
            }

            function getColor_t(d, metric) {
                if (metric === "DONATION") {
                    return d >= 2675472 ? '#B10026' :
                           d >= 271551  ? '#B10026' :
                           d >= 3316  ? '#E31A1C' :
                           d >= 1828  ? '#FC4E2A' :
                           d >= 592   ? '#FD8D3C' :
                           d >= 133   ? '#FEB24C' :
                           d >= 130   ? '#FED976' :
                           d >= 1   ? '#FFFFB2' :
                           d === 0   ? '#D4D4D4' :
                           '#FFFFB2';
                }
                else if (metric === "CAPITA") {
                    return d >= 44534232 ? '#0C2C84' :
                           d >= 10738345  ? '#0C2C84' :
                           d >= 1635418  ? '#225EA8' :
                           d >= 864218  ? '#1D91C0' :
                           d >= 429965   ? '#41B6C4' :
                           d >= 148955   ? '#7FCDBB' :
                           d >= 147594   ? '#C7E9B4' :
                           d >= 1   ? '#FFFFCC' :
                           d === 0   ? '#D4D4D4' :
                           '#FFFFCC';
                }
                else if (metric === "DEVIATION_2007" || metric === "DEVIATION_2010" || metric === "DEVIATION_2014" ) {
                    //console.log(d);
                    return d >= 200 ? '#ff4d4d' :
                           d >= 175  ? '#ff4d4d' :
                           d >= 150  ? '#ff7a7a' :
                           d >= 125  ? '#ffa6a6' :
                           d >= 75   ? '#fff2cc' :
                           d >= 50   ? '#7fbfff' :
                           d >= 25   ? '#40a0ff' :
                           d >= 1   ? '#0080ff' :
                           d === 0   ? '#D4D4D4' :
                           '#D4D4D4';
                }
            }

            function render_chart2(songId, inputData) {

                var margin = 20;

                var margin0 = {top: 22, right: 25, bottom: 22, left: 65},
                    w = 320,
                    h = 280;

                function barStack(seriesData) {
                    var l = seriesData[0].length
                    while (l--) {
                        var posBase = 0; // positive base
                        var negBase = 0; // negative base

                        seriesData.forEach(function(d) {
                            d = d[l]
                            d.size = Math.abs(d.y)
                            if (d.y < 0) {
                                d.y0 = negBase
                                negBase -= d.size
                            }
                            else {
                                d.y0 = posBase = posBase + d.size
                            }
                        })
                    }
                    seriesData.extent = d3.extent(
                        d3.merge(
                            d3.merge(
                                seriesData.map(function(e) {
                                    return e.map(function(f) { return [f.y0,f.y0-f.size] })
                                })
                            )
                        )
                    )
                }
                var data = inputData;
                var color = d3.scale.ordinal()
                    .range(["#4D8E27", "#FF665A", "#176B86", "#777777"]);

                var color2 = d3.scale.ordinal()
                    .range(["url('#purpleStripe')", "url('#hash4_5')", "rgba(0,0,0,0)", "rgba(0,0,0,0)"]);

                var x = d3.scale.ordinal()
                    .domain([2007, " ", "  ", "   ", 2011, "    ", "     ", "        ", 2015])
                    .rangeRoundBands([margin0.left, w-margin0.right], .1)

                var y = d3.scale.linear()
                    .range([h-margin0.top,0+margin0.bottom]);

                var xAxis = d3.svg.axis()
                    .scale(x)
                    .orient("bottom")
                    .ticks(3, 4);

                var yAxis = d3.svg.axis()
                    .scale(y)
                    .orient("left")
                    .tickFormat(function(d) { return d+100 + "%"; })
                    .ticks(5);

                barStack(data);
                y.domain(data.extent);

                svg = d3.select("#playchart")
                    .append("svg")
                    .attr("class", "playchart_" + songId)
                    .attr("width", w)
                    .attr("height", h);

                svg.append("g")
                    .attr("class", "background_group");

                // filters go in defs element
                var defs = svg.append("defs");

                // create filter with id #drop-shadow
                // height=130% so that the shadow is not clipped
                var filter = defs.append("filter")
                    .attr("id", "drop-shadow")
                    .attr("height", "130%");

                // SourceAlpha refers to opacity of graphic that this filter will be applied to
                // convolve that with a Gaussian with standard deviation 3 and store result
                // in blur
                filter.append("feGaussianBlur")
                    .attr("in", "SourceAlpha")
                    .attr("stdDeviation", 5)
                    .attr("result", "blur");

                // translate output of Gaussian blur to the right and downwards with 2px
                // store result in offsetBlur
                filter.append("feOffset")
                    .attr("in", "blur")
                    .attr("dx", 5)
                    .attr("dy", 5)
                    .attr("result", "offsetBlur");

                // overlay original SourceGraphic over translated blurred opacity by using
                // feMerge filter. Order of specifying inputs is important!
                var feMerge = filter.append("feMerge");

                feMerge.append("feMergeNode")
                    .attr("in", "offsetBlur")
                feMerge.append("feMergeNode")
                    .attr("in", "SourceGraphic");

                function make_y_axis() {
                    return d3.svg.axis()
                        .scale(y)
                        .orient("left")
                        .ticks(5)
                }

                // Draw the y Grid lines
                svg.append("g")
                    .attr("class", "grid")
                    .attr("transform", "translate(" + margin0.left + " 0)")
                    .call(make_y_axis()
                        .tickSize(-230, 0, 0)
                        .tickFormat("")
                    )

                svg.selectAll(".series2")
                    .data(data)
                    .enter()
                    .append("g")
                    .classed("series2", true)
                    .style("fill", function(d,i) { return color2(i) })
                    .selectAll("rect")
                    .data(Object)
                    .enter()
                        .append("rect")
                        .attr("x", function(d, i) { return x(x.domain()[i]) })
                        .attr("width", x.rangeBand())
                        .attr("y", function(d) { return y(0); })
                        .attr("height", function(d) { return y(0) - y(0); })
                        .transition()
                        .duration(0)
                        .attr("y", function(d) { return y(d.y0) })
                        .attr("height", function(d) { return y(0) - y(d.size) })
                        .style('stroke', '#333')
                        .style('stroke-width', '0.5')
                        .style('opacity', '1');


                function selectYear(index) {
                    if (index === 0) {
                        return 2007;
                    }
                    else if (index === 1) {
                        return 2008;
                    }
                    else if (index === 2) {
                        return 2009;
                    }
                    else if (index === 3) {
                        return 2010;
                    }
                    else if (index === 4) {
                        return 2011;
                    }
                    else if (index === 5) {
                        return 2012;
                    }
                    else if (index === 6) {
                        return 2013;
                    }
                    else if (index === 7) {
                        return 2014;
                    }
                    else if (index === 8) {
                        return 2015;
                    }
                }

                function changeOpacity(selection) {
                    if (metric === "DEVIATION_2007") {
                        selection.each(function(){
                            var element = d3.select(this);
                            if (parseInt(element.attr('data-year')) <= 2009) {
                                element
                                    .style("opacity", "0.7")
                                    .style("filter", "url(#drop-shadow)");
                            }
                            else {
                                element
                                    .style("opacity", "0.3");
                            }
                        });
                    }
                    else if (metric === "DEVIATION_2010") {
                        selection.each(function(){
                            var element = d3.select(this);
                            if (parseInt(element.attr('data-year')) > 2009 && parseInt(element.attr('data-year')) < 2014) {
                                element
                                    .style("opacity", "0.7")
                                    .style("filter", "url(#drop-shadow)");
                            }
                            else {
                                element
                                    .style("opacity", "0.3");
                            }
                        });
                    }
                    else if (metric === "DEVIATION_2014") {
                        selection.each(function(){
                            var element = d3.select(this);
                            if (parseInt(element.attr('data-year')) >= 2014) {
                                element
                                    .style("opacity", "0.7")
                                    .style("filter", "url(#drop-shadow)");
                            }
                            else {
                                element
                                    .style("opacity", "0.3");
                            }
                        });
                    }
                }

                svg.selectAll(".series")
                    .data(data)
                    .enter()
                    .append("g")
                    .classed("series", true)
                    //.style("fill", function(d,i) { return color(i) })
                    .selectAll("rect")
                    .data(Object)
                    .enter()
                        .append("rect")
                        .attr('class', 'deviationBar')
                        .attr("x", function(d, i) { return x(x.domain()[i]) })
                        .attr("data-year", function(d, i) { return selectYear(i) })
                        .attr("data-value", function(d, i) { return d.y })
                        .attr("width", x.rangeBand())
                        .attr("y", function(d) { return y(0); })
                        .attr("height", function(d) { return y(0) - y(0); })
                        .transition()
                        .duration(0)
                        .attr("y", function(d) { return y(d.y0) })
                        .attr("height", function(d) { return y(0) - y(d.size) })
                        .style('stroke', '#333')
                        .style('stroke-width', '0.5')
                        .style("fill", function(d,i) { return getColor_t(parseInt(d.y)+100, "DEVIATION_2007") });
                        //.style('opacity', '0.7');
                        //.on("mouseover", function() { tooltip.style("display", null); })
                        //.on("mouseout", function() { tooltip.style("display", "none"); })
                        /*.on("mousemove", function(d) {
                            var xPosition = d3.mouse(this)[0] - 35;
                            var yPosition = d3.mouse(this)[1] - 5;
                            tooltip.attr("transform", "translate(" + xPosition + "," + yPosition + ")");
                            tooltip.select("text").text(d.y);
                        });*/

                svg.selectAll(".deviationBar")
                    .call(changeOpacity);

                svg.append("g")
                    .attr("class", "axis x")
                    .attr("transform", "translate(0 " + y(0) + ")")
                    .call(xAxis);

                svg.append("g")
                    .attr("class", "axis y")
                    .attr("transform", "translate(" + margin0.left + " 0)")
                    .call(yAxis);

                /* Here we add tooltips */

                // Prep the tooltip bits, initial display is hidden
                var tooltip = svg.append("g")
                    .attr("class", "tooltip")
                    .style("display", "none");

                tooltip.append("rect")
                    .attr("width", 30)
                    .attr("height", 20)
                    .attr("fill", "white")
                    .style("opacity", 0.5);

                tooltip.append("text")
                    .attr("x", 15)
                    .attr("dy", "1.2em")
                    .style("text-anchor", "middle")
                    .attr("font-size", "12px")
                    .attr("font-weight", "bold");

                /*svg.append("rect")
                    .attr("class", "Pattern_BG")
                    .attr("width", 20)
                    .attr("height", 20)
                    .attr("x", 100)
                    .attr("y", 100)
                    .style("opacity", 1)
                    .style("fill", '#FFFFFF');


                svg.append("rect")
                    .attr("class", "Pattern1")
                    .attr("width", 20)
                    .attr("height", 20)
                    .attr("x", 100)
                    .attr("y", 100)
                    .style("opacity", 1)
                    .style("fill", 'url(#purpleStripe)');
                    //.style("fill", 'url(#hash4_5)');*/

            }

            var mapboxAccessToken = "pk.eyJ1IjoiYmFsa2V5IiwiYSI6IkVEUHU3UVEifQ.ULJj3xCWhQvw4_jLEnHpTQ";
            //var map = L.map('map').setView([47.162494, 19.503304], 8);

            var southWest = L.latLng(45.1423360997, 14.8645019531),
                northEast = L.latLng(49.8370967393, 25.4333496094),
                bounds = L.latLngBounds(southWest, northEast);

            var map = L.map('map', {
                center: [47.162494, 19.503304],
                zoom: 7,
                maxBounds: bounds,
                minZoom: 7,
                maxZoom: 14
            });

           L.tileLayer('https://api.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=' + mapboxAccessToken, {
                id: 'mapbox.streets',
                //id: 'balkey.pc3h3mph',
                //id: 'balkey.6eu1n7wa',
                attribution: "<a href='http://www.atlatszo.hu'>atlatszo.hu</a>"
            }).addTo(map);


            function getColor_m(d, metric) {
                if (metric === "DONATION") {
                    return d >= 2675472 ? '#B10026' :
                           d >= 590828  ? '#B10026' :
                           d >= 477281  ? '#E31A1C' :
                           d >= 411403  ? '#FC4E2A' :
                           d >= 339351   ? '#FD8D3C' :
                           d >= 316725   ? '#FEB24C' :
                           d >= 200732   ? '#FED976' :
                           d >= 1   ? '#FFFFB2' :
                           '#FFFFB2';
                }
                else if (metric === "CAPITA") {

                    return d >= 1543228 ? '#0C2C84' :
                           d >= 1400640  ? '#0C2C84' :
                           d >= 1008979  ? '#225EA8' :
                           d >= 883432  ? '#1D91C0' :
                           d >= 805802   ? '#41B6C4' :
                           d >= 672658   ? '#7FCDBB' :
                           d >= 387974   ? '#C7E9B4' :
                           d >= 1   ? '#FFFFCC' :
                           '#FFFFCC';
                }
            }
            function getColor_k(d, metric) {
                if (metric === "DONATION") {
                    return d >= 2292160 ? '#B10026' :
                           d >= 393346  ? '#B10026' :
                           d >= 155903  ? '#E31A1C' :
                           d >= 45328  ? '#FC4E2A' :
                           d >= 31826  ? '#FD8D3C' :
                           d >= 17689   ? '#FEB24C' :
                           d >= 17620   ? '#FED976' :
                           d >= 1   ? '#FFFFB2' :
                           '#FFFFB2';
                }
                else if (metric === "CAPITA") {
                    return d >= 6713015 ? '#0C2C84' :
                           d >= 3991456  ? '#0C2C84' :
                           d >= 1214538  ? '#225EA8' :
                           d >= 1022784  ? '#1D91C0' :
                           d >= 730618  ? '#41B6C4' :
                           d >= 561674   ? '#7FCDBB' :
                           d >= 555546   ? '#C7E9B4' :
                           d >= 1   ? '#FFFFCC' :
                           '#FFFFCC';
                }
            }

            function getPattern(d) {
                if (metric === "DEVIATION_2007") {
                    return d["2007"] === "RULER" ? 'url(#purpleStripe)' :
                           d["2007"] === "UD"  ? 'url(#hash4_5)' :
                          'rgba(0,0,0,0)';
                }
                else if (metric === "DEVIATION_2010") {
                    return d["2010"] === "RULER" ? 'url(#purpleStripe)' :
                           d["2010"] === "UD"  ? 'url(#hash4_5)' :
                          'rgba(0,0,0,0)';
                }
                else if (metric === "DEVIATION_2014") {
                    return d["2014"] === "RULER" ? 'url(#purpleStripe)' :
                           d["2014"] === "UD"  ? 'url(#hash4_5)' :
                          'rgba(0,0,0,0)';
                }
            }

            function stripes_style (feature) {
                if (typeof feature['properties']['DEVIATION_PATTERN'] != "undefined") {
                    return {
                        fillColor: getPattern(feature['properties']['DEVIATION_PATTERN']),
                        fillOpacity: 0.6,
                        weight: 1,
                        opacity: 1,
                        color: '#333333',
                        dashArray: '',
                        className: feature['properties']['TEL_NEV']
                    };
                }
                else {
                    return {
                        fillColor: "#FFFFFF",
                        fillOpacity: 0.6,
                        weight: 1,
                        opacity: 1,
                        color: '#333333',
                        dashArray: '',
                        className: feature['properties']['TEL_NEV']
                    };
                }
            }

            function style(feature) {
                if (adminUnit === "megye" ) {
                    return {
                        fillColor: getColor_m(feature['properties'][metric], metric),
                        weight: 1,
                        opacity: 0.8,
                        color: '#333333',
                        dashArray: '',
                        fillOpacity: 0.6,
                        className: feature['properties']['TEL_NEV']
                    };
                }
                else if (adminUnit === "kisterseg") {
                    return {
                        fillColor: getColor_k(feature['properties'][metric], metric),
                        weight: 1,
                        opacity: 0.8,
                        color: '#333333',
                        dashArray: '',
                        fillOpacity: 0.6,
                        className: feature['properties']['TEL_NEV']

                    };
                }
                else if (adminUnit === "telepules") {
                    return {
                        fillColor: getColor_t(feature['properties'][metric], metric),
                        weight: 1,
                        opacity: 0.8,
                        color: '#333333',
                        dashArray: '',
                        fillOpacity: 0.6
                    };
                }
            }

            function highlightFeature(e) {
                var layer = e.target;

                layer.setStyle({
                    weight: 2,
                    color: '#000000',
                    dashArray: '',
                    fillOpacity: 0.2,
                    //fill:"url(img/cash.png)"
                });

                if (!L.Browser.ie && !L.Browser.opera) {
                    layer.bringToFront();
                }
                info.update(layer.feature.properties);

                $('.legend_elem').each(function(){
                    $(this).removeClass("legend_featured");
                    if (parseInt($(this).attr('data-range_start')) <= parseInt(layer['feature']['properties'][metric]) && parseInt($(this).attr('data-range_end')) >= parseInt(layer['feature']['properties'][metric])) {
                        $(this).addClass("legend_featured");
                    }
                    else if (parseInt($(this).attr('data-range_start')) <= parseInt(layer['feature']['properties'][metric]) && $(this).attr('data-range_end') === "undefined") {
                        $(this).addClass("legend_featured");
                    }
                });
            }

            function resetHighlight(e) {
                geojson.resetStyle(e.target);
                $('.legend_elem').each(function(){
                    $(this).removeClass("legend_featured");
                });
                info.update();
            }

            function zoomToFeature(e) {

                /*if (map.getZoom() <= 13) {
                    var coordinates = e.target.getBounds().getCenter();
                    var cM = [coordinates.lat, coordinates.lng];
                    var a = map.getZoom();
                    map.setView(new L.LatLng(cM[0], cM[1]),a+1, {animate: true});
                }
                else {
                    var a = map.getZoom();
                    map.setZoom(a + 1);
                }*/

                if (map.getZoom() >= 12 || timeSeries === "DEVIATION") {
                    var layer = e.target;
                    var popupContent;
                    if (layer.properties && layer.properties.TEL_NEV) {
                        var popupContent =L.popup({autoPanPaddingTopLeft: L.point(10, 100), autoPanPaddingBottomRight: L.point(350, 10)}).setContent("<a href='adat.atlatszo.hu/eu-shiny-app/?varos=" + encodeURIComponent(feature.properties.TEL_NEV)+"' target='_blank'><div class='popupButton' data-uid='"+feature.properties.TEL_NEV+"'>"+feature.properties.TEL_NEV+":<br>az összes pályázat listázása"+"</div></a>");
                    }
                    pop = layer.bindPopup(popupContent);
                    pop.openPopup();
                }
                //map.fitBounds(e.target.getBounds());
            }

            var markersById = {};

            function onEachFeatureIndex(feature, layer) {

                markersById[feature.properties.TEL_NEV] = layer;
            }

            function onEachFeature(feature, layer) {

                markersById[feature.properties.TEL_NEV] = layer;
                layer.on('dblclick', function(e) {

                    if (map.getZoom() < 12 && timeSeries != "DEVIATION") {
                        var coordinates = e.target.getBounds().getCenter();
                        var cM = [coordinates.lat, coordinates.lng];
                        var a = map.getZoom();
                        map.setView(new L.LatLng(cM[0], cM[1]),a+1, {animate: true});
                    }
                    else {
                        //var a = map.getZoom();
                        //map.setZoom(a + 1);
                    }
                });

                if (map.getZoom() >= 12 || timeSeries === "DEVIATION") {
                    if (feature.properties && feature.properties.TEL_NEV) {
                        var content = L.popup({autoPanPaddingTopLeft: L.point(10, 100), autoPanPaddingBottomRight: L.point(350, 10)}).setContent("<a href='http://adat.atlatszo.hu/eu-shiny-app/?varos=" + encodeURIComponent(feature.properties.TEL_NEV)+"' target='_blank'><div class='popupButton' data-uid='"+feature.properties.TEL_NEV+"'>"+feature.properties.TEL_NEV+":<br>az összes pályázat listázása"+"</div></a>");
                        layer.bindPopup(content);
                    }
                }

                layer.on({
                    mouseover: highlightFeature,
                    mouseout: resetHighlight,
                    click: zoomToFeature
                });
            }

            var info = L.control();

            var chart = L.control();

            info.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'info popup'); // create a div with a class "info"
                this.update();
                return this._div;
            };

            chart.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'chart'); // create a div with a class "info"
                return this._div;
            };

            // method that we will use to update the control based on feature properties passed
            info.update = function (props) {

                if (props) {
                    $('#playchart').show();
                }
                else {
                    if ($('.chart:hover').length === 0) {
                        //UPDATE1 HERE TOOL
                        $('.playchart_1').remove();
                        $('#playchart').hide();
                    }
                }

                if (metric === "DONATION") {
                    if (props) {
                        this._div.innerHTML = '<div class="info_header">'+props["TEL_NEV"]+'</div>' +
                                              '<b>' + '<h4 class="original_info">Átlagos EU támogatás (millió Ft / év):</h4>' + '</b><div class="info_ammount original_info">' + (props[metric]/9).format(0, 3, ' ') + ' millió Ft</div>' +
                                              '<b>' + '<h4 class="hidden_info" >Összes EU támogatás (millió Ft):</h4>' + '</b><div class="info_ammount hidden_info">' + (props[metric]/9).format(0, 3, ' ') + ' millió Ft</div>';
                    }
                    else {
                        if ($('.chart:hover').length === 0) {
                            this._div.innerHTML = 'Átlagos évenkénti EU támogatás 2007-2015.';
                        }
                    }
                }
                else if (metric === "CAPITA") {
                    if (props) {
                        this._div.innerHTML = '<div class="info_header">'+props["TEL_NEV"]+'</div>' +
                                              '<b>' + '<h4>Egy főre jutó EU támogatás (fő / év / Ft):</h4>' + '</b><div class="info_ammount">' + (props[metric]/9).format(0, 3, ' ') + ' Ft</div>';
                    }
                    else {
                        if ($('.chart:hover').length === 0) {
                            this._div.innerHTML = 'Egy főre jutó évi EU támogatás 2007-2015.';
                        }
                    }
                }
                else if (metric === "DEVIATION_2007") {
                    if (props) {
                        this._div.innerHTML = '<div class="info_header">'+props["TEL_NEV"]+'</div>' +
                                              '<b>' + '<h4>Mo. fő / év átlagától való eltérés (2007-2009):</h4>' + '</b><div class="info_ammount">' + parseInt(props[metric]) + ' %</div>';
                    }
                    else {
                        if ($('.chart:hover').length === 0) {
                            this._div.innerHTML = 'Választási ciklus szerinti EU támogatás';
                        }
                    }
                }
                else if (metric === "DEVIATION_2010") {
                    if (props) {
                        this._div.innerHTML = '<div class="info_header">'+props["TEL_NEV"]+'</div>' +
                                              '<b>' + '<h4>Mo. fő / év átlagától való eltérés (2010-2013):</h4>' + '</b><div class="info_ammount">' + parseInt(props[metric]) + ' %</div>';
                    }
                    else {
                        if ($('.chart:hover').length === 0) {
                            this._div.innerHTML = 'Választási ciklus szerinti EU támogatás';
                        }
                    }
                }
                else if (metric === "DEVIATION_2014") {
                    if (props) {
                        this._div.innerHTML = '<div class="info_header">'+props["TEL_NEV"]+'</div>' +
                                              '<b>' + '<h4>Mo. fő / év átlagától való eltérés (2014-2015):</h4>' + '</b><div class="info_ammount">' + parseInt(props[metric]) + ' %</div>';
                    }
                    else {
                        if ($('.chart:hover').length === 0) {
                            this._div.innerHTML = 'Választási ciklus szerinti EU támogatás';
                        }
                    }
                }

                if (typeof props != "undefined") {
                    //console.log(JSON.stringify(props.DONATION_TIME));
                    if (typeof props[timeSeries] != "undefined") {
                        if (timeSeries == "DONATION_TIME" || timeSeries == "CAPITA_TIME") {
                            $('.playchart_1').remove();
                            render_chart("1", props[timeSeries]);
                            $('#playchart').show();
                        }
                        else if (timeSeries == "DEVIATION") {
                            $('.playchart_1').remove();
                            render_chart2("1", props[timeSeries]);
                            $('#playchart').show();
                        }
                    }
                    else {
                        if ($('.chart:hover').length === 0) {
                            $('#playchart').hide();
                        }
                    }
                }

            };

            info.addTo(map);
            chart.addTo(map);

            /*$.ajax({
                dataType: "json",
                async: true,
                url: "static/js/telepules.json",
                success: function(data) {
                    //$(data.features).each(function(key, data) {
                        //geojson.addData(data);
                    //});

                    indexHamlet = L.geoJson(data, {
                        onEachFeature: onEachFeatureIndex
                    });

                },
                error: function() {
                    alert('Busted!');
                },
                complete: function() {
                }
            });*/

            indexHamlet = L.geoJson(telepules, {onEachFeature: onEachFeatureIndex});

            var legend = L.control({position: 'bottomright'});

            legend.onAdd = function (map) {

                if (map.getZoom() <= 9) {
                    if (metric === "DONATION") {
                        var div = L.DomUtil.create('div', 'info legend'),
                            grades = [0, 200731, 316724, 339350, 411402, 477280, 590827],
                            labels = [];

                        // loop through our density intervals and generate a label with a colored square for each interval
                        for (var i = 0; i < grades.length; i++) {
                        div.innerHTML +=
                            '<div class="legend_elem" data-range_start="'+(grades[i]+1)+'" data-range_end="'+grades[i + 1]+'">'+'<div class="legend_icon" style="background:' + getColor_m(grades[i] + 1, metric) + '"></div>' +
                            '<div class="legend_text2">'+((grades[i]+1)/9).format(0, 3, ' ') + (grades[i + 1] ? ' &ndash; ' + (grades[i + 1]/9).format(0, 3, ' ') + ' millió Ft<br>' :'+ millió Ft')+'</div></div>';
                        }

                        return div;
                    }
                    else if (metric === "CAPITA") {
                        var div = L.DomUtil.create('div', 'info legend'),
                            grades = [0, 387974, 672658, 805802, 883432, 1008979, 1400640],
                            labels = [];

                        // loop through our density intervals and generate a label with a colored square for each interval
                        for (var i = 0; i < grades.length; i++) {
                        div.innerHTML +=
                            '<div class="legend_elem" data-range_start="'+(grades[i]+1)+'" data-range_end="'+grades[i + 1]+'">'+'<div class="legend_icon" style="background:' + getColor_m(grades[i] + 1, metric) + '"></div>' +
                            '<div class="legend_text2">'+((grades[i]+1)/9).format(0, 3, ' ') + (grades[i + 1] ? ' &ndash; ' + (grades[i + 1]/9).format(0, 3, ' ') + ' Ft<br>' :'+ Ft')+'</div></div>';
                        }

                        return div;
                    }
                    else if (metric === "DEVIATION_2007" || metric === "DEVIATION_2010" || metric === "DEVIATION_2014") {
                        var div = L.DomUtil.create('div', 'info legend'),
                            grades = [0, 25, 50, 75, 125, 150, 175],
                            labels = [];
                        for (var i = 0; i < grades.length; i++) {
                        div.innerHTML +=
                            '<div class="legend_elem" data-range_start="'+(grades[i]+1)+'" data-range_end="'+grades[i + 1]+'">'+'<div class="legend_icon" style="background:' + getColor_t(grades[i] + 1, metric) + '"></div>' +
                            '<div class="legend_text2">'+(grades[i]+1).format(0, 3, ' ') + (grades[i + 1] ? ' &ndash; ' + (grades[i + 1]).format(0, 3, ' ') + ' %<br>' :'+ %')+'</div></div>';
                        }
                        return div;
                    }

                }
                else if (map.getZoom() <= 11) {
                    if (metric === "DONATION") {
                        var div = L.DomUtil.create('div', 'info legend'),
                            grades = [0, 17620, 17689, 31826, 45328, 155903, 393346],
                            labels = [];

                        // loop through our density intervals and generate a label with a colored square for each interval
                        for (var i = 0; i < grades.length; i++) {
                        div.innerHTML +=
                            '<div class="legend_elem" data-range_start="'+(grades[i]+1)+'" data-range_end="'+grades[i + 1]+'">'+'<div class="legend_icon" style="background:' + getColor_k(grades[i] + 1, metric) + '"></div>' +
                            '<div class="legend_text2">'+((grades[i]+1)/9).format(0, 3, ' ') + (grades[i + 1] ? ' &ndash; ' + (grades[i + 1]/9).format(0, 3, ' ') + ' millió Ft<br>' :'+ millió Ft')+'</div></div>';
                        }

                        return div;
                    }
                    else if (metric === "CAPITA") {
                        var div = L.DomUtil.create('div', 'info legend'),
                            grades = [0, 555546, 561674, 730618, 1022784, 1214538, 3991456],
                            labels = [];

                        // loop through our density intervals and generate a label with a colored square for each interval
                        for (var i = 0; i < grades.length; i++) {
                        div.innerHTML +=
                            '<div class="legend_elem" data-range_start="'+(grades[i]+1)+'" data-range_end="'+grades[i + 1]+'">'+'<div class="legend_icon" style="background:' + getColor_k(grades[i] + 1, metric) + '"></div>' +
                            '<div class="legend_text2">'+((grades[i]+1)/9).format(0, 3, ' ') + (grades[i + 1] ? ' &ndash; ' + (grades[i + 1]/9).format(0, 3, ' ') + ' Ft<br>' :'+ Ft')+'</div></div>';
                        }

                        return div;
                    }
                    else if (metric === "DEVIATION_2007" || metric === "DEVIATION_2010" || metric === "DEVIATION_2014") {
                        var div = L.DomUtil.create('div', 'info legend'),
                            grades = [0, 25, 50, 75, 125, 150, 175],
                            labels = [];
                        for (var i = 0; i < grades.length; i++) {
                        div.innerHTML +=
                            '<div class="legend_elem" data-range_start="'+(grades[i]+1)+'" data-range_end="'+grades[i + 1]+'">'+'<div class="legend_icon" style="background:' + getColor_t(grades[i] + 1, metric) + '"></div>' +
                            '<div class="legend_text2">'+(grades[i]+1).format(0, 3, ' ') + (grades[i + 1] ? ' &ndash; ' + (grades[i + 1]).format(0, 3, ' ') + ' %<br>' :'+ %')+'</div></div>';
                        }
                        return div;
                    }

                }
                else {
                    if (metric === "DONATION") {
                        var div = L.DomUtil.create('div', 'info legend'),
                            grades = [0, 130, 133, 592, 1828, 3316, 271551],
                            labels = [];

                        // loop through our density intervals and generate a label with a colored square for each interval
                        for (var i = 0; i < grades.length; i++) {
                        div.innerHTML +=
                            '<div class="legend_elem" data-range_start="'+(grades[i]+1)+'" data-range_end="'+grades[i + 1]+'">'+'<div class="legend_icon" style="background:' + getColor_t(grades[i] + 1, metric) + '"></div>' +
                            '<div class="legend_text2">'+((grades[i]+1)/9).format(0, 3, ' ') + (grades[i + 1] ? ' &ndash; ' + (grades[i + 1]/9).format(0, 3, ' ') + ' millió Ft<br>' :'+ millió Ft')+'</div></div>';
                        }

                        return div;
                    }
                    else if (metric === "CAPITA") {
                        var div = L.DomUtil.create('div', 'info legend'),
                            grades = [0, 147594, 148955, 429965, 864218, 1635418, 10738345],
                            labels = [];

                        // loop through our density intervals and generate a label with a colored square for each interval
                        for (var i = 0; i < grades.length; i++) {
                        div.innerHTML +=
                            '<div class="legend_elem" data-range_start="'+(grades[i]+1)+'" data-range_end="'+grades[i + 1]+'">'+'<div class="legend_icon" style="background:' + getColor_t(grades[i] + 1, metric) + '"></div>' +
                            '<div class="legend_text2">'+((grades[i]+1)/9).format(0, 3, ' ') + (grades[i + 1] ? ' &ndash; ' + (grades[i + 1]/9).format(0, 3, ' ') + ' Ft<br>' :'+ Ft')+'</div></div>';
                        }

                        return div;
                    }
                    else if (metric === "DEVIATION_2007" || metric === "DEVIATION_2010" || metric === "DEVIATION_2014") {
                        var div = L.DomUtil.create('div', 'info legend'),
                            grades = [0, 25, 50, 75, 125, 150, 175],
                            labels = [];
                        for (var i = 0; i < grades.length; i++) {
                        div.innerHTML +=
                            '<div class="legend_elem" data-range_start="'+(grades[i]+1)+'" data-range_end="'+grades[i + 1]+'">'+'<div class="legend_icon" style="background:' + getColor_t(grades[i] + 1, metric) + '"></div>' +
                            '<div class="legend_text2">'+(grades[i]+1).format(0, 3, ' ') + (grades[i + 1] ? ' &ndash; ' + (grades[i + 1]).format(0, 3, ' ') + ' %<br>' :'+ %')+'</div></div>';
                        }

                        return div;
                    }
                }
            };

            legend.addTo(map);

            map.on('zoomend', function() {
                // here's where you decided what zoom levels the layer should and should
                // not be available for: use javascript comparisons like < and > if
                // you want something other than just one zoom level, like
                // (map.getZoom > 10)
                $('.playchart_1').remove();
                $('#playchart').hide();
                info.update();

                //if (metric != "DEVIATION_2007" || metric != "DEVIATION_2010" || metric != "DEVIATION_2014") {
                if (timeSeries != "DEVIATION") {
                    if (map.getZoom() <= 9) {
                        adminUnit = "megye";
                        $.ajax({
                            dataType: "json",
                            async: true,
                            url: "static/js/megye.json",
                            success: function(data) {
                                //$(data.features).each(function(key, data) {
                                    //geojson.addData(data);
                                //});

                                map.removeLayer(geojson);
                                geojson = L.geoJson(data, {
                                    style: style,
                                    onEachFeature: onEachFeature
                                });
                                geojson.addTo(map);
                            },
                            error: function() {
                                alert('Busted!');
                            },
                            complete: function() {
                            }
                        });
                        map.removeControl(legend)
                        legend.addTo(map);

                    }
                    else if (map.getZoom() <= 11) {
                        adminUnit = "kisterseg";
                        $.ajax({
                            dataType: "json",
                            async: true,
                            url: "static/js/kisterseg.json",
                            success: function(data) {
                                //$(data.features).each(function(key, data) {
                                    //geojson.addData(data);
                                //});

                                map.removeLayer(geojson);
                                geojson = L.geoJson(data, {
                                    style: style,
                                    onEachFeature: onEachFeature
                                });
                                geojson.addTo(map);
                            },
                            error: function() {
                                alert('Busted!');
                            },
                            complete: function() {
                            }
                        });
                        map.removeControl(legend)
                        legend.addTo(map);
                        // setFilter is available on L.mapbox.featureLayers only. Here
                        // we're hiding and showing the default marker layer that's attached
                        // to the map - change the reference if you want to hide or show a
                        // different featureLayer.
                        // If you want to hide or show a different kind of layer, you can use
                        // similar methods like .setOpacity(0) and .setOpacity(1)
                        // to hide or show it.
                        //map.featureLayer.setFilter(function() { return true; });
                    }
                    else {
                        adminUnit = "telepules";
                        $.ajax({
                            dataType: "json",
                            async: true,
                            url: "static/js/telepules.json",
                            success: function(data) {
                                //$(data.features).each(function(key, data) {
                                    //geojson.addData(data);
                                //});

                                map.removeLayer(geojson);
                                geojson = L.geoJson(data, {
                                    style: style,
                                    onEachFeature: onEachFeature
                                });
                                geojson.addTo(map);
                            },
                            error: function() {
                                alert('Busted!');
                            },
                            complete: function() {
                            }
                        });
                        map.removeControl(legend)
                        legend.addTo(map);
                        //map.featureLayer.setFilter(function() { return false; });
                    }
                }
            });

            var getUrlParameter = function getUrlParameter(sParam) {
                var sPageURL = decodeURIComponent(window.location.search.substring(1)),
                    sURLVariables = sPageURL.split('&'),
                    sParameterName,
                    i;
                for (i = 0; i < sURLVariables.length; i++) {
                    sParameterName = sURLVariables[i].split('=');

                    if (sParameterName[0] === sParam) {
                        return sParameterName[1] === undefined ? true : sParameterName[1];
                    }
                }
            };

            $(document).ready(function(){
               //$('.leaflet-top.leaflet-right').append('<div id="playchart"> \
               $('.chart').append('<div id="playchart"> \
                                                            <div class="legend_header">Támogatás összesen:</div> \
                                                            <div class="legend_subheader"></div> \
                                                            <div class="chart_legend_a"> \
                                                                <div class="legend_left legend_chart EU" id="EU"> \
                                                                    <div class="legend_icon"></div> \
                                                                    <div class="legend_text">EU 2007-2013 tám. program</div> \
                                                                </div> \
                                                                <div class="legend_right legend_chart KTIA" id="KTIA"> \
                                                                    <div class="legend_icon"></div> \
                                                                    <div class="legend_text">Kutatási, techn. és innov. alap</div> \
                                                                </div> \
                                                                <div class="legend_left legend_chart szechenyi USZ" id="szechenyi"> \
                                                                    <div class="legend_icon"></div> \
                                                                    <div class="legend_text">Új Széchenyi<br>Terv</div> \
                                                                </div> \
                                                                <div class="legend_right legend_chart ujszechenyi SZ" id="ujszechenyi"> \
                                                                    <div class="legend_icon"></div> \
                                                                    <div class="legend_text">Széchenyi<br>2020</div> \
                                                                </div> \
                                                                <div class="legend_left legend_chart nemzeti N" id="nemzeti"> \
                                                                    <div class="legend_icon"></div> \
                                                                    <div class="legend_text">Nemzeti Fej-<br>lesztési Terv</div> \
                                                                </div> \
                                                            </div> \
                                                            <div class="chart_legend_b"> \
                                                                <div class="legend_left legend_chart REIGN"> \
                                                                    <div class="legend_icon"></div> \
                                                                    <div class="legend_text">Kormánypárti polgármester</div> \
                                                                </div> \
                                                                <div class="legend_right legend_chart OPP"> \
                                                                    <div class="legend_icon"></div> \
                                                                    <div class="legend_text">Ellenzéki polgármester</div> \
                                                                </div> \
                                                                <div class="legend_left legend_chart IND"> \
                                                                    <div class="legend_icon"></div> \
                                                                    <div class="legend_text">Független polgármester</div> \
                                                                </div> \
                                                                <div class="legend_right legend_chart NA"> \
                                                                    <div class="legend_icon"></div> \
                                                                    <div class="legend_text">Nem áll rendel-kezésre információ</div> \
                                                                </div> \
                                                            </div> \
                                                        </div>');

                $(".main_search").autocomplete({
                    minlength: 8,
                    autofocus: "true",
                    //appendTo: ".search_wrapper",
                    appendTo: ".autocomplete_container",
                    source: autocompletelist,
                    focus: function( event, ui ) {
                        //$( ".main_search" ).val( ui.item.song_title + " (" + ui.item.artist + ")");

                        return false;
                    },
                    select: function( event, ui ) {
                        $( ".main_search" ).val( ui.item.value );
                        var searchHamlet = ui.item.value;
                        var objectSearched = markersById[searchHamlet];
                        var coordinates = objectSearched.getBounds().getCenter();
                        var cM = [coordinates.lat, coordinates.lng];
                        map.setView(new L.LatLng(cM[0], cM[1]),12, {animate: true});
                        markersById[searchHamlet].setStyle({
                                weight: 4,
                                color: '#4D8E27',
                                dashArray: '10',
                                fillColor:"url(#hash4_4)",
                                fillOpacity: 0.2
                            });

                        setTimeout (function(){
                            markersById[searchHamlet].setStyle({
                                weight: 4,
                                color: '#4D8E27',
                                dashArray: '10',
                                fillColor:"url(#hash4_4)",
                                fillOpacity: 0.2
                            });
                        },1000);

                        info.update(objectSearched['feature']['properties']);

                        $('.legend_elem').each(function(){
                            $(this).removeClass("legend_featured");
                                if (parseInt($(this).attr('data-range_start')) <= parseInt(objectSearched['feature']['properties'][metric]) && parseInt($(this).attr('data-range_end')) >= parseInt(objectSearched['feature']['properties'][metric])) {
                                    $(this).addClass("legend_featured");
                                }
                                else if (parseInt($(this).attr('data-range_start')) <= parseInt(objectSearched['feature']['properties'][metric]) && $(this).attr('data-range_end') === "undefined") {
                                    $(this).addClass("legend_featured");
                                }
                        });

                        map.on('movestart', function() {
                            geojson.resetStyle(markersById[searchHamlet]);

                        });

                        //VARIATION TWO!!!
                        /*var lista = telepules["features"];
                        var lookup;

                        for ( var i = 0, l = lista.length; i < l; i++ ) {
                            if (lista[i]['properties']['TEL_NEV'] === ui.item.value) {
                                lookup = lista[i];
                                var multipolygon = L.geoJson(lookup);
                                multipolygon.addTo(map);
                                map.fitBounds(multipolygon.getBounds());

                                multipolygon.setStyle({
                                    weight: 5,
                                    color: 'red',
                                    dashArray: '3',
                                    fillOpacity: 0,
                                    //fill:"url(img/cash.png)"
                                });
                                if (!L.Browser.ie && !L.Browser.opera) {
                                    multipolygon.bringToFront();
                                }
                                info.update(multipolygon['properties']);

                                map.removeLayer(multipolygon);

                            }
                        }*/

                        return false;
                    }
                });

                $('#human_logo').hover(function() {

                    if (metric != "CAPITA") {
                        $('.playchart_1').remove();
                        $('#playchart').hide();
                        $("#human_logo").addClass('hover_logo');
                        $('.popup.leaflet-control').addClass('hover_pop');
                        $('.popup.leaflet-control').html('Egy főre jutó évi EU támogatás 2007-2015.');
                        $('.popup').append(loader);
                    }
                },
                function() {
                    if (metric ==="DONATION") {
                        $('.popup.leaflet-control').html('Átlagos évi EU támogatás 2007-2015.');
                        $("#human_logo").removeClass('hover_logo');
                        $('.popup.leaflet-control').removeClass('hover_pop');
                    }
                    else if (metric ==="CAPITA") {
                        $('.popup.leaflet-control').html('Egy főre jutó évi EU támogatás 2007-2015.');
                        $("#human_logo").removeClass('hover_logo');
                        $("#human_logo").addClass('active_logo');
                        $('.popup.leaflet-control').removeClass('hover_pop');

                    }
                    else {
                        $('.popup.leaflet-control').html('Választási ciklus szerinti EU támogatás');
                        $("#human_logo").removeClass('hover_logo');
                        $('.popup.leaflet-control').removeClass('hover_pop');
                    }
                });

                $('#human_logo').on('click', function() {
                    $('.party_selector_wrapper').hide();
                    //$('.popup.leaflet-control').removeClass('hover_pop');
                    //$('.popup.leaflet-control').html('Egy főre jutó évi EU támogatás 2007-2015.');
                    if (map.getZoom() <= 9) {
                        adminUnit = "megye";
                    }
                    else if (map.getZoom() <= 11) {
                        adminUnit = "kisterseg";
                    }
                    else {
                        adminUnit = "telepules";
                    }

                    if (metric === "DEVIATION_2007" || metric === "DEVIATION_2010" || metric === "DEVIATION_2014") {
                        map.removeLayer(stripes);

                    }
                    if (metric != "CAPITA") {
                        metric = "CAPITA";
                        timeSeries = "CAPITA_TIME";
                        $('.chart_legend_b').hide();
                        $('.chart_legend_a').show();
                        $('.spinner').show();
                        //map.removeLayer(geojson);
                        $('.logo').each(function(){
                           $(this).removeClass('active_logo');
                           $(this).removeClass('hover_logo');
                        });
                        $("#human_logo").addClass('active_logo');
                        $('.info h4').text('Egy főre jutó EU támogatás (fő / Ft)');
                        if (adminUnit === "megye") {
                            $.ajax({
                                dataType: "json",
                                async: true,
                                url: "static/js/megye.json",
                                delay: 3,
                                success: function(data) {
                                    //$(data.features).each(function(key, data) {
                                        //geojson.addData(data);
                                    //});

                                    map.removeLayer(geojson);

                                    geojson = L.geoJson(data, {
                                        style: style,
                                        onEachFeature: onEachFeature
                                    });
                                    geojson.addTo(map);
                                    //alert('Uploaded!!!');
                                },
                                error: function() {
                                    alert('Busted!');
                                },
                                complete: function() {
                                    $('.spinner').remove();
                                    $('.popup.leaflet-control').removeClass('hover_pop');
                                }
                            });
                        }
                        else if (adminUnit === "kisterseg") {
                            $.ajax({
                                dataType: "json",
                                async: true,
                                url: "static/js/kisterseg.json",
                                delay: 3,
                                success: function(data) {
                                    //$(data.features).each(function(key, data) {
                                        //geojson.addData(data);
                                    //});

                                    map.removeLayer(geojson);

                                    geojson = L.geoJson(data, {
                                        style: style,
                                        onEachFeature: onEachFeature
                                    });
                                    geojson.addTo(map);
                                    //alert('Uploaded!!!');
                                },
                                error: function() {
                                    alert('Busted!');
                                },
                                complete: function() {
                                    $('.spinner').remove();
                                    $('.popup.leaflet-control').removeClass('hover_pop');
                                }
                            });
                        }
                        else if (adminUnit === "telepules") {
                            $.ajax({
                                dataType: "json",
                                async: true,
                                url: "static/js/telepules.json",
                                success: function(data) {
                                    //$(data.features).each(function(key, data) {
                                        //geojson.addData(data);
                                    //});

                                    map.removeLayer(geojson);

                                    geojson = L.geoJson(data, {
                                        style: style,
                                        onEachFeature: onEachFeature
                                    });
                                    geojson.addTo(map);
                                    //alert('Uploaded!!!');
                                },
                                error: function() {
                                    alert('Busted!');
                                },
                                complete: function() {
                                    $('.spinner').remove();
                                    $('.popup.leaflet-control').removeClass('hover_pop');
                                }
                            });
                        }
                        map.removeControl(legend)
                        legend.addTo(map);
                   }
                });

                $('#cash_logo').hover(function() {
                    if (metric != "DONATION") {
                        $('.playchart_1').remove();
                        $('#playchart').hide();
                        $("#cash_logo").addClass('hover_logo');
                        $('.popup.leaflet-control').addClass('hover_pop');
                        $('.popup.leaflet-control').html('Átlagos évi EU támogatás 2007-2015.');
                        $('.popup').append(loader);
                    }
                },
                function() {
                    if (metric ==="DONATION") {
                        $('.popup.leaflet-control').html('Átlagos évi EU támogatás 2007-2015.');
                        $("#cash_logo").removeClass('hover_logo');
                        $("#cash_logo").addClass('active_logo');
                        $('.popup.leaflet-control').removeClass('hover_pop');
                    }
                    else if (metric ==="CAPITA") {
                        $('.popup.leaflet-control').html('Egy főre jutó évi EU támogatás 2007-2015.');
                        $("#cash_logo").removeClass('hover_logo');
                        $('.popup.leaflet-control').removeClass('hover_pop');
                    }
                    else {
                        $('.popup.leaflet-control').html('Választási ciklus szerinti EU támogatás');
                        $("#cash_logo").removeClass('hover_logo');
                        $('.popup.leaflet-control').removeClass('hover_pop');
                    }
                });

                $('#cash_logo').on('click', function() {
                    $('.party_selector_wrapper').hide();
                    //$('.popup.leaflet-control').removeClass('hover_pop');
                    //$('.popup.leaflet-control').html('Átlagos évenkénti EU támogatás 2007-2015.');
                    if (map.getZoom() <= 9) {
                        adminUnit = "megye";
                    }
                    else if (map.getZoom() <= 11) {
                        adminUnit = "kisterseg";
                    }
                    else {
                        adminUnit = "telepules";
                    }
                    if (metric === "DEVIATION_2007" || metric === "DEVIATION_2010" || metric === "DEVIATION_2014") {
                        map.removeLayer(stripes);
                    }
                    if(metric != "DONATION") {
                        metric = "DONATION";
                        timeSeries = "DONATION_TIME";
                        $('.spinner').show();
                        $('.chart_legend_b').hide();
                        $('.chart_legend_a').show();
                        $('.logo').each(function(){
                           $(this).removeClass('active_logo');
                           $(this).removeClass('hover_logo');
                        });
                        $("#cash_logo").addClass('active_logo');
                        $('.info h4').text('Átlagos EU támogatás (millió Ft / év)');
                        if (adminUnit === "megye") {
                            $.ajax({
                                dataType: "json",
                                async: true,
                                url: "static/js/megye.json",
                                delay: 3,
                                success: function(data) {
                                    //$(data.features).each(function(key, data) {
                                        //geojson.addData(data);
                                    //});

                                    map.removeLayer(geojson);

                                    geojson = L.geoJson(data, {
                                        style: style,
                                        onEachFeature: onEachFeature
                                    });
                                    geojson.addTo(map);
                                    //alert('Uploaded!!!');
                                },
                                error: function() {
                                    alert('Busted!');
                                },
                                complete: function() {
                                    $('.spinner').remove();
                                    $('.popup.leaflet-control').removeClass('hover_pop');
                                }
                            });
                        }
                        else if (adminUnit === "kisterseg") {
                            $.ajax({
                                dataType: "json",
                                async: true,
                                url: "static/js/kisterseg.json",
                                success: function(data) {
                                    //$(data.features).each(function(key, data) {
                                        //geojson.addData(data);
                                    //});

                                    map.removeLayer(geojson);

                                    geojson = L.geoJson(data, {
                                        style: style,
                                        onEachFeature: onEachFeature
                                    });
                                    geojson.addTo(map);
                                    //alert('Uploaded!!!');
                                },
                                error: function() {
                                    alert('Busted!');
                                },
                                complete: function() {
                                    $('.spinner').remove();
                                    $('.popup.leaflet-control').removeClass('hover_pop');
                                }
                            });
                        }
                        else if (adminUnit === "telepules") {
                            $.ajax({
                                dataType: "json",
                                async: true,
                                url: "static/js/telepules.json",
                                success: function(data) {
                                    //$(data.features).each(function(key, data) {
                                        //geojson.addData(data);
                                    //});

                                    map.removeLayer(geojson);

                                    geojson = L.geoJson(data, {
                                        style: style,
                                        onEachFeature: onEachFeature
                                    });
                                    geojson.addTo(map);
                                    //alert('Uploaded!!!');
                                },
                                error: function() {
                                    alert('Busted!');
                                },
                                complete: function() {
                                    $('.spinner').remove();
                                    $('.popup.leaflet-control').removeClass('hover_pop');
                                }
                            });
                        }
                        map.removeControl(legend)
                        legend.addTo(map);
                   }
                });

                $('#bank_logo').hover(function() {
                    if (timeSeries != "DEVIATION") {
                        $('.playchart_1').remove();
                        $('#playchart').hide();
                        $("#bank_logo").addClass('hover_logo');
                        $('.popup.leaflet-control').addClass('hover_pop');
                        $('.popup.leaflet-control').html('Választási ciklus szerinti EU támogatás');
                        $('.popup').append(loader);
                    }
                },
                function() {
                    if (metric ==="DONATION") {
                        $('.popup.leaflet-control').html('Átlagos évi EU támogatás 2007-2015.');
                        $("#bank_logo").removeClass('hover_logo');
                        $('.popup.leaflet-control').removeClass('hover_pop');
                    }
                    else if (metric ==="CAPITA") {
                        $('.popup.leaflet-control').html('Egy főre jutó évi EU támogatás 2007-2015.');
                        $("#bank_logo").removeClass('hover_logo');
                        $('.popup.leaflet-control').removeClass('hover_pop');
                    }
                    else {
                        $('.popup.leaflet-control').html('Választási ciklus szerinti EU támogatás');
                        $("#bank_logo").removeClass('hover_logo');
                        $("#bank_logo").addClass('active_logo');
                        $('.popup.leaflet-control').removeClass('hover_pop');
                    }
                });

                $('#bank_logo').on('click', function() {
                    $('.party_selector_wrapper').show();
                    //$('.popup.leaflet-control').removeClass('hover_pop');
                    //$('.popup.leaflet-control').html('Választási ciklus szerinti EU támogatás');
                    //$('.popup').append('<div class="loader_wrapper"><img class="preloader_gif" src="img/loadertest.gif"/></div>');
                    //if  (metric != "DEVIATION_2007" || metric != "DEVIATION_2010" || metric != "DEVIATION_2014") {
                    if  (timeSeries != "DEVIATION") {
                            $('.spinner').show();
                            var chosenParty = $("#party_selector").val();
                            metric = chosenParty;
                            timeSeries = "DEVIATION";
                            adminUnit = "telepules";

                            //stripes = L.geoJson(telepules, {
                            //    style: stripes_style,
                            //    onEachFeature: onEachFeature
                            //}).addTo(map);

                            //geojson = L.geoJson(telepules, {
                            //    style: style,
                            //    onEachFeature: onEachFeature
                            //}).addTo(map);

                            $.ajax({
                                dataType: "json",
                                async: true,
                                url: "static/js/telepules.json",
                                success: function(data) {
                                    //$(data.features).each(function(key, data) {
                                        //geojson.addData(data);
                                    //});

                                    map.removeLayer(geojson);

                                    stripes = L.geoJson(data, {
                                        style: stripes_style,
                                        onEachFeature: onEachFeature
                                    }).addTo(map);

                                    geojson = L.geoJson(data, {
                                        style: style,
                                        onEachFeature: onEachFeature
                                    });
                                    geojson.addTo(map);
                                    //alert('Uploaded!!!');
                                },
                                error: function() {
                                    alert('Busted!');
                                },
                                complete: function() {
                                    $('.spinner').remove();
                                    $('.popup.leaflet-control').removeClass('hover_pop');
                                }
                            });


                            $('.chart_legend_a').hide();
                            $('.chart_legend_b').show();
                            $('.logo').each(function(){
                                $(this).removeClass('active_logo');
                                $(this).removeClass('hover_logo');
                            });
                            $("#bank_logo").addClass('active_logo');
                            $('.info h4').text('2007-2015 országos átlagától vett eltérés (%)');

                            map.removeControl(legend)
                            legend.addTo(map);
                    }

                });



                $('#party_selector').on("change", function(){
                    var selectedValue = $(this).val();
                    if (selectedValue === "DEVIATION_2007") {
                        metric = "DEVIATION_2007";
                        $('.popup').html('2007-2009. szerinti EU támogatás')
                        $('.popup').append(loader);

                    }
                    else if (selectedValue === "DEVIATION_2010") {
                        metric = "DEVIATION_2010";
                        $('.popup').html('2010-2013. szerinti EU támogatás')
                        $('.popup').append(loader);
                    }
                    else if (selectedValue === "DEVIATION_2014") {
                        metric = "DEVIATION_2014";
                        $('.popup').html('2014-2015. szerinti EU támogatás')
                        $('.popup').append(loader);
                    }
                    $('.popup.leaflet-control').addClass('hover_pop');
                    $('.spinner').show();
                    $.ajax({
                        dataType: "json",
                        async: true,
                        url: "static/js/telepules.json",
                        success: function(data) {
                            //$(data.features).each(function(key, data) {
                            //geojson.addData(data);
                            //});

                            map.removeLayer(stripes);
                            map.removeLayer(geojson);

                            stripes = L.geoJson(data, {
                                style: stripes_style,
                                onEachFeature: onEachFeature
                            }).addTo(map);

                            geojson = L.geoJson(data, {
                                style: style,
                                onEachFeature: onEachFeature
                            });
                            geojson.addTo(map);
                        },
                        error: function() {
                            alert('Busted!');
                        },
                        complete: function() {
                            $('.spinner').remove();
                            $('.popup.leaflet-control').removeClass('hover_pop');
                        }
                    });
                });


                function imageLoader(image, elem) {
                    var c = new Image();
                    c.onload = function(){
                        elem.css("background-image", "url("+ image+")");
                        elem.css("background-size", "100%, 100%");
                    }

                    c.src = image;
                }
                imageLoader("/img/cash_active3.png", $(".hidden_reloader"));
                imageLoader("/img/cash_hover.png", $(".hidden_reloader"));
                imageLoader("/img/human_active.png", $(".hidden_reloader"));
                imageLoader("/img/human_hover.png", $(".hidden_reloader"));
                imageLoader("/img/bank_active.png", $(".hidden_reloader"));
                imageLoader("/img/bank_hover.png", $(".hidden_reloader"));

                //PATTERN INJECTION VIA D3
                var svg2 = d3.select("body").append("svg").attr("id", "d3svga")
                    .attr("width", 120)
                    .attr("height", 120);

                var pattern_stripes = svg2.append("defs")
                    .attr({id: "striper"})
                    .append("pattern")
                    .attr({ id:"pattern_stripe", width:"4", height:"4", patternUnits:"userSpaceOnUse", patternTransform:"rotate(45)"})
                    .append("rect")
                    .attr({ width:"2", height:"4", transform:"translate(0,0)", fill:"white" });

                svg2.select("#striper")
                    .append("mask")
                    .attr({id:"mask-stripe"})
                    .append("rect")
                    .attr({x:"0", y: "0", width:"100%", height:"100%", fill:"url(#pattern_stripe" });

                var pattern1 = svg2.append("defs")
                    .append("pattern")
                    .attr({ id:"hash4_4", width:"10", height:"10", patternUnits:"userSpaceOnUse", patternTransform:"rotate(60)"})
                    .append("rect")
                    .attr({ width:"2", height:"10", transform:"translate(0,0)", fill:"#4D8E27" });

                var patternPurpleStripe = svg2.append("defs")
                    .append("pattern")
                    .attr({ id:"purpleStripe", width:"10", height:"10", patternUnits:"userSpaceOnUse", patternTransform:"rotate(60)"})
                    .append("rect")
                    //.attr({ width:"2", height:"10", transform:"translate(0,0)", fill:"#876fc1" });
                    .attr({ width:"2", height:"10", transform:"translate(0,0)", fill:"rgba(51,51,51,0.9" });

                var pattern2 = svg2.append("defs")
                    .append("pattern")
                    .attr({ id:"hash4_5", x:"6", y:"6", width:"8", height:"8", patternUnits:"userSpaceOnUse", patternTransform:"rotate(45)"})
                    .append("rect")
                    //.attr({ x:"4", y:"4", width:"4", height:"4", transform:"translate(0,0)", fill:"#876fc1" });
                    .attr({ x:"4", y:"4", width:"4", height:"4", transform:"translate(0,0)", fill:"rgba(51,51,51,0.9" });

               var pattern3 = svg2.append("defs")
                    .append("pattern")
                    .attr({ id:"hash4_6", x:"0", y:"0", width:"14", height:"25", patternUnits:"userSpaceOnUse"})
                    .append("svg:image")
                    .attr({ x:"0", y:"0", width:"14", height:"25"})
                    .attr("xlink:href","data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NiIgaGVpZ2h0PSIxMDAiPgo8cmVjdCB3aWR0aD0iNTYiIGhlaWdodD0iMTAwIiBmaWxsPSIjZjhkMjAzIj48L3JlY3Q+CjxwYXRoIGQ9Ik0yOCA2NkwwIDUwTDAgMTZMMjggMEw1NiAxNkw1NiA1MEwyOCA2NkwyOCAxMDAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmZjYyOSIgc3Ryb2tlLXdpZHRoPSIyIj48L3BhdGg+CjxwYXRoIGQ9Ik0yOCAwTDI4IDM0TDAgNTBMMCA4NEwyOCAxMDBMNTYgODRMNTYgNTBMMjggMzQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmZTUwMyIgc3Ryb2tlLXdpZHRoPSIyIj48L3BhdGg+Cjwvc3ZnPg==");

                $('.chart').on('mouseover', function(){
                });

                $('.chart').on('mouseleave', function(){
                    $('.playchart_1').remove();
                    $('#playchart').hide();
                });

                $('.legend_chart').on('mouseenter', function() {
                    var idSelector = String($(this).attr('id'));
                    var totalMetric = 0;
                    $('.bars').each(function() {
                        if ($(this).is('.bars.'+idSelector)) {
                            $(this).show();
                            var heightB = $(this).attr('height');
                            $(this).attr("y", 205-heightB);
                            if ($(this).attr("height") != "0") {
                                var metricBar = $(this).attr('data-balance');
                                totalMetric += parseInt(metricBar);
                            }
                        }
                        else {
                            $(this).hide();
                        }
                    });
                    $('.trendline').hide();
                    if (idSelector === "EU") {
                        $('h4.hidden_info').html('EU 2007-2013 (millió Ft / év):');
                    }
                    else if (idSelector === "KTIA") {
                        $('h4.hidden_info').html('Kut. és Techn. Innov. Alap (millió Ft / év):');
                    }
                    else if (idSelector === "szechenyi") {
                        $('h4.hidden_info').html('Új Széchenyi terv (millió Ft / év):');
                    }
                    else if (idSelector === "ujszechenyi") {
                        $('h4.hidden_info').html('Széchenyi 2020 (millió Ft / év):');
                    }
                    else if (idSelector === "nemzeti") {
                        $('h4.hidden_info').html('Nemzeti Fejlesztési Terv (millió Ft / év):');
                    }
                    $('.info_ammount.hidden_info').html((totalMetric/9).format(0, 3, ' ')+" millió Ft");
                    $('.info_ammount.original_info').hide();
                    $('.info_ammount.hidden_info').show();
                    $('h4.original_info').hide();
                    $('h4.hidden_info').show();
                    //alert(totalMetric);
                });

                $('.legend_chart').on('mouseleave', function() {
                    var idSelector = String($(this).attr('id'));
                    $('.bars').each(function() {
                        if ($(this).is('.bars.'+idSelector)) {
                            var newyPos = $(this).attr("data-selected");
                            $(this).attr('y', newyPos);
                            $(this).show();
                        }
                        else {
                            $(this).show();
                        }
                    });
                    $('.trendline').show();
                    $('.info_ammount.hidden_info').hide();
                    $('.info_ammount.original_info').show();
                    $('h4.hidden_info').hide();
                    $('h4.original_info').show();
                });

                //$('.popup').append('<div class="loader_wrapper"><img class="preloader_gif" src="img/loadertest.gif"/></div>');
                $('.sk-cube-grid').hide();

                //$('select').select2();

                if (getUrlParameter('telepules') ) {
                    $('title').text('EU támogatások | '+getUrlParameter('telepules'));
                    $( ".main_search" ).val( getUrlParameter('telepules') );
                        var searchHamlet = getUrlParameter('telepules');
                        var objectSearched = markersById[searchHamlet];
                        var coordinates = objectSearched.getBounds().getCenter();
                        var cM = [coordinates.lat, coordinates.lng];
                        map.setView(new L.LatLng(cM[0], cM[1]),12, {animate: true});
                        markersById[searchHamlet].setStyle({
                                weight: 4,
                                color: '#4D8E27',
                                dashArray: '10',
                                fillColor:"url(#hash4_4)",
                                fillOpacity: 0.2
                            });
                        setTimeout (function(){
                            markersById[searchHamlet].setStyle({
                                weight: 4,
                                color: '#4D8E27',
                                dashArray: '10',
                                fillColor:"url(#hash4_4)",
                                fillOpacity: 0.2
                            });
                            info.update(objectSearched['feature']['properties']);

                        },2000);

                        $('.legend_elem').each(function(){
                            $(this).removeClass("legend_featured");
                                if (parseInt($(this).attr('data-range_start')) <= parseInt(objectSearched['feature']['properties'][metric]) && parseInt($(this).attr('data-range_end')) >= parseInt(objectSearched['feature']['properties'][metric])) {
                                    $(this).addClass("legend_featured");
                                }
                                else if (parseInt($(this).attr('data-range_start')) <= parseInt(objectSearched['feature']['properties'][metric]) && $(this).attr('data-range_end') === "undefined") {
                                    $(this).addClass("legend_featured");
                                }
                        });

                        map.on('movestart', function() {
                            geojson.resetStyle(markersById[searchHamlet]);

                        });
                }

                if (getUrlParameter('view')) {
                    var viewToSelect = getUrlParameter('view');
                    if (viewToSelect === "1") {
                        metric = "DONATION";
                        timeSeries = "DONATION_TIME";
                        $('.logo').each(function(){
                           $(this).removeClass('active_logo');
                           $(this).removeClass('hover_logo');
                        });
                        $("#cash_logo").addClass('active_logo');
                        map.removeControl(legend);
                        legend.addTo(map);
                        $.ajax({
                            dataType: "json",
                            async: true,
                            url: "static/js/megye.json",
                            success: function(data) {
                                //$(data.features).each(function(key, data) {
                                    //geojson.addData(data);
                                //});

                                geojson = L.geoJson(data, {
                                    style: style,
                                    onEachFeature: onEachFeature
                                });
                                geojson.addTo(map);
                            },
                            error: function() {
                                alert('Busted!');
                            },
                            complete: function() {
                            }
                        });
                    }
                    else if (viewToSelect === "2") {
                        metric = "CAPITA";
                        timeSeries = "CAPITA_TIME";
                        $('.logo').each(function(){
                           $(this).removeClass('active_logo');
                           $(this).removeClass('hover_logo');
                        });
                        $("#human_logo").addClass('active_logo');
                        map.removeControl(legend);
                        legend.addTo(map);
                        $.ajax({
                            dataType: "json",
                            async: true,
                            url: "static/js/megye.json",
                            success: function(data) {
                                //$(data.features).each(function(key, data) {
                                    //geojson.addData(data);
                                //});

                                geojson = L.geoJson(data, {
                                    style: style,
                                    onEachFeature: onEachFeature
                                });
                                geojson.addTo(map);
                            },
                            error: function() {
                                alert('Busted!');
                            },
                            complete: function() {
                            }
                        });
                    }
                    else if (viewToSelect === "3") {
                        if (getUrlParameter('year')) {
                            var year = parseInt(getUrlParameter('year'));
                            if (year < 2010) {
                                metric = "DEVIATION_2007";
                                $("#party_selector").val("DEVIATION_2007");
                            }
                            else if (year < 2014) {
                                metric = "DEVIATION_2010";
                                $("#party_selector").val("DEVIATION_2010");
                            }
                            else {
                                metric = "DEVIATION_2014";
                                $("#party_selector").val("DEVIATION_2014");
                            }
                        }
                        else {
                            metric = "DEVIATION_2007";
                        }
                        timeSeries = "DEVIATION";
                        adminUnit = "telepules";
                        $('.logo').each(function(){
                           $(this).removeClass('active_logo');
                           $(this).removeClass('hover_logo');
                        });
                        $("#bank_logo").addClass('active_logo');
                        $('.party_selector_wrapper').show();
                        map.removeControl(legend);
                        legend.addTo(map);
                        $.ajax({
                            dataType: "json",
                            async: true,
                            url: "static/js/telepules.json",
                            success: function(data) {
                                //$(data.features).each(function(key, data) {
                                    //geojson.addData(data);
                                //});

                                stripes = L.geoJson(data, {
                                    style: stripes_style,
                                    onEachFeature: onEachFeature
                                }).addTo(map);

                                geojson = L.geoJson(data, {
                                    style: style,
                                    onEachFeature: onEachFeature
                                });
                                geojson.addTo(map);
                                //alert('Uploaded!!!');
                            },
                            error: function() {
                                alert('Busted!');
                            },
                            complete: function() {
                            }
                        });
                        $('.chart_legend_a').hide();
                        $('.chart_legend_b').show();
                    }
                }
                else {
                    $.ajax({
                        dataType: "json",
                        async: true,
                        url: "static/js/megye.json",
                        success: function(data) {
                            //$(data.features).each(function(key, data) {
                                //geojson.addData(data);
                            //});

                            geojson = L.geoJson(data, {
                                style: style,
                                onEachFeature: onEachFeature
                            });
                            geojson.addTo(map);
                        },
                        error: function() {
                            alert('Busted!');
                        },
                        complete: function() {
                        }
                    });
                }
            });

        </script>
    </body>
</html>